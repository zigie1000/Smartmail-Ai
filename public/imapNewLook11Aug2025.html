<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SmartEmail | IMAP Reader</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Aesthetics / Best practice: restrained system font stack, soft cards, good contrast -->
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --brand:#2563eb;
    --line:#e6e8ee; --ring:#c7d2fe; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --chip:#eef2ff; --chipText:#1e3a8a; --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#f7f9ff 0%,#f3f5fb 100%);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
    color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1160px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  header h1{font-size:22px;margin:0;letter-spacing:.2px}
  header .chip{
    font-size:12px;background:var(--chip);color:var(--chipText);
    border:1px solid #dbe4ff;border-radius:999px;padding:6px 10px
  }

  .card{
    background:var(--card);border-radius:var(--radius);
    box-shadow:0 10px 30px rgba(2,8,20,.08), 0 1px 0 var(--line);
    border:1px solid var(--line)
  }
  .section{padding:16px 16px 10px}

  .row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .row > .col{display:flex;flex-direction:column}
  label{font-size:12px;color:var(--muted);margin:8px 2px 6px}
  input,select{
    padding:12px 12px;border:1px solid var(--line);border-radius:10px;background:#fbfcff;
    outline:none; transition:.15s border, .15s box-shadow;
  }
  input:focus,select:focus{
    border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(37,99,235,0.08)
  }
  input[type="number"]{max-width:160px}
  .toolbar{
    display:flex;flex-wrap:wrap;gap:10px;margin:14px 0;align-items:center
  }
  button{
    padding:10px 14px;border:none;border-radius:10px;cursor:pointer;transition:.15s transform,.15s filter
  }
  .btn{background:var(--brand);color:#fff}
  .btn.secondary{background:#eef2ff;color:#1e3a8a}
  .btn.ghost{background:#f3f4f6;color:#374151}
  .btn:active{transform:translateY(1px)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .alert{border-radius:12px;padding:11px 12px;margin:12px 0;font-size:14px}
  .alert.err{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca}
  .alert.ok{background:#dcfce7;color:#064e3b;border:1px solid #bbf7d0}

  .list{margin-top:14px}
  .email{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px 12px 10px;margin:10px 0}
  .email-header{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .from{color:var(--muted);font-size:12px}
  .subject{font-weight:600}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #dbeafe;background:#eff6ff}
  .tag.imp{background:#fff7ed;border-color:#fed7aa}
  .meta{display:flex;gap:8px;align-items:center}
  .sel{margin-right:6px}
  details{margin-top:8px}
  summary{cursor:pointer;color:#374151}

  .skeleton{animation:pulse 1.3s ease-in-out infinite;background:linear-gradient(90deg,#f3f4f6, #e5e7eb, #f3f4f6);background-size:300% 100%}
  .sk-card{height:86px;border-radius:12px;margin:10px 0}
  @keyframes pulse{0%{background-position:0 0}100%{background-position:100% 0}}

  .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border-top:1px solid var(--line)}
  .pager{display:flex;gap:6px;align-items:center}
  .pager button{padding:8px 12px}
  .hint{font-size:12px;color:var(--muted)}

  .note{font-size:12px;color:#334155;background:#f1f5f9;border:1px dashed #cbd5e1;border-radius:10px;padding:8px 10px}

  @media (max-width:1024px){ .row{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){
    .row{grid-template-columns:1fr}
    .email-header{grid-template-columns:1fr auto}
    .footer{flex-direction:column;align-items:flex-start}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M2 7l10 6 10-6" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 17l10 6 10-6" stroke="#93c5fd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 12l10 6 10-6" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h1>IMAP Reader & Classifier</h1>
      <span class="chip" title="Works with any IMAP provider">Universal IMAP</span>
    </header>

    <!-- Credentials -->
    <section class="card section" aria-labelledby="formHeading">
      <h2 id="formHeading" style="margin:0 0 6px 2px;font-size:14px;color:#334155;">Connection</h2>
      <div class="row">
        <div class="col">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="name@domain.com" autocomplete="username" />
        </div>
        <div class="col">
          <label for="password">App Password</label>
          <input id="password" type="password" placeholder="•••• •••• •••• ••••" autocomplete="current-password" />
        </div>
        <div class="col">
          <label for="host">IMAP Host</label>
          <input id="host" placeholder="imap.gmail.com" />
        </div>
        <div class="col">
          <label for="port">Port</label>
          <input id="port" type="number" value="993" min="1" />
        </div>
      </div>

      <!-- Provider + TLS + Accounts -->
      <div class="row" style="margin-top:6px">
        <div class="col">
          <label for="provider">Provider</label>
          <select id="provider">
            <option value="gmail" selected>Gmail</option>
            <option value="icloud">iCloud (Apple)</option>
            <option value="yahoo">Yahoo</option>
            <option value="outlook">Outlook / Office 365</option>
            <option value="zoho">Zoho</option>
            <option value="fastmail">Fastmail</option>
            <option value="gmx">GMX</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="col">
          <label for="tlsToggle">TLS</label>
          <select id="tlsToggle">
            <option value="true" selected>On (recommended)</option>
            <option value="false">Off</option>
          </select>
        </div>
        <div class="col">
          <label for="accountSelect">Saved Accounts</label>
          <select id="accountSelect">
            <option value="">— none —</option>
          </select>
        </div>
        <div class="col" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn ghost" id="btnSaveAcct" title="Save to this browser only">Save</button>
          <button class="btn ghost" id="btnUseAcct" title="Load into fields">Use</button>
          <button class="btn ghost" id="btnDelAcct" title="Remove saved account">Delete</button>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="btnFetch">Fetch & Classify</button>
        <button class="btn ghost" id="btnRefresh" title="Fetch only new items in the selected range">Refresh</button>

        <span class="hint">Range</span>
        <select id="range" aria-label="Time range">
          <option value="120">Last 2 hours</option>
          <option value="720">Last 12 hours</option>
          <option value="1440">Last 1 day</option>
          <option value="2880" selected>Last 2 days</option>
          <option value="10080">Last 7 days</option>
          <option value="20160">Last 14 days</option>
        </select>

        <button class="btn secondary" id="btnImportant">Filter: Important</button>
        <button class="btn ghost" id="btnAll">Show All</button>
        <button class="btn ghost" id="btnExportJson">Export JSON</button>
        <button class="btn ghost" id="btnExportCsv">Export CSV</button>
        <button class="btn secondary" id="btnSendSelected">Send Selected → Generator</button>

        <span class="hint" id="lastSyncHint" style="margin-left:auto;">&nbsp;</span>
      </div>

      <div class="note">Tip: Most providers require an <b>App Password</b> for IMAP. For Gmail and iCloud, enable 2FA and create an app-specific password.</div>
      <div id="msg" aria-live="polite"></div>
    </section>

    <!-- List -->
    <section class="card list" id="listCard" aria-live="polite" aria-busy="false">
      <div id="list" style="padding:6px 12px 8px"></div>
    </section>

    <div class="card footer">
      <div class="pager">
        <button id="prev" aria-label="Previous page">&larr; Prev</button>
        <span class="hint" id="pageInfo">Page 1</span>
        <button id="next" aria-label="Next page">Next &rarr;</button>
        <span class="hint">Page size</span>
        <select id="pageSize" aria-label="Page size">
          <option>10</option><option selected>20</option><option>50</option>
        </select>
      </div>
      <div class="hint" id="countInfo"></div>
    </div>
  </div>

<script>
(() => {
  const API = '/api/imap';
  let cache = [];
  let view = [];
  let page = 1;
  let pageSize = 20;

  const list = document.getElementById('list');
  const msg = document.getElementById('msg');
  const pageInfo = document.getElementById('pageInfo');
  const countInfo = document.getElementById('countInfo');
  const pageSizeSel = document.getElementById('pageSize');
  const rangeSel = document.getElementById('range');
  const lastSyncHint = document.getElementById('lastSyncHint');

  // Provider presets & account manager
  const PRESETS = {
    gmail:    { host: 'imap.gmail.com',        port: 993, tls: true, note: 'Gmail: use an App Password (2FA).' },
    icloud:   { host: 'imap.mail.me.com',      port: 993, tls: true, note: 'iCloud: use an App-Specific Password.' },
    yahoo:    { host: 'imap.mail.yahoo.com',   port: 993, tls: true, note: 'Yahoo: use an App Password.' },
    outlook:  { host: 'outlook.office365.com', port: 993, tls: true, note: 'Outlook/365: IMAP must be enabled; app password or OAuth.' },
    zoho:     { host: 'imap.zoho.com',         port: 993, tls: true },
    fastmail: { host: 'imap.fastmail.com',     port: 993, tls: true },
    gmx:      { host: 'imap.gmx.com',          port: 993, tls: true },
    custom:   { host: '',                      port: 993, tls: true }
  };

  const providerSel  = document.getElementById('provider');
  const tlsToggleSel = document.getElementById('tlsToggle');
  const acctSel      = document.getElementById('accountSelect');
  const btnSaveAcct  = document.getElementById('btnSaveAcct');
  const btnUseAcct   = document.getElementById('btnUseAcct');
  const btnDelAcct   = document.getElementById('btnDelAcct');

  providerSel.addEventListener('change', () => {
    const p = PRESETS[providerSel.value] || PRESETS.custom;
    setVal('host', p.host);
    setVal('port', String(p.port));
    tlsToggleSel.value = p.tls ? 'true' : 'false';
    if (p.note) showMsg(p.note, 'ok');
  });

  const LS_KEY = 'imapAccounts';
  function loadAccounts(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
  function saveAccounts(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }
  function refreshAccountSelect(){
    const list = loadAccounts();
    acctSel.innerHTML = '<option value="">— none —</option>' +
      list.map((a,i)=>`<option value="${i}">${escapeHtml(a.name || a.email)}</option>`).join('');
  }
  function getFormAccount(){
    return {
      name: getVal('email') || 'Account',
      email: getVal('email'),
      host: getVal('host'),
      port: Number(getVal('port')) || 993,
      tls: (tlsToggleSel.value === 'true')
    };
  }
  function applyAccount(a){
    setVal('email', a.email || '');
    setVal('host', a.host || '');
    setVal('port', String(a.port || 993));
    tlsToggleSel.value = a.tls ? 'true' : 'false';
  }
  function setVal(id, v){ const el = document.getElementById(id); if (el) el.value = v; }
  function getVal(id){ const el = document.getElementById(id); return (el?.value || '').trim(); }

  btnSaveAcct.addEventListener('click', () => {
    const acc = getFormAccount();
    if (!acc.email || !acc.host) { showMsg('Email and Host are required to save.', 'err'); return; }
    const list = loadAccounts();
    const idx = list.findIndex(a => (a.email||'').toLowerCase() === acc.email.toLowerCase());
    if (idx >= 0) list[idx] = acc; else list.push(acc);
    saveAccounts(list);
    refreshAccountSelect();
    showMsg('Account saved in this browser.', 'ok');
  });

  btnUseAcct.addEventListener('click', () => {
    const list = loadAccounts();
    const idx = Number(acctSel.value);
    if (Number.isNaN(idx) || !list[idx]) { showMsg('Select a saved account first.', 'err'); return; }
    applyAccount(list[idx]);
    showMsg('Account loaded.', 'ok');
  });

  btnDelAcct.addEventListener('click', () => {
    const list = loadAccounts();
    const idx = Number(acctSel.value);
    if (Number.isNaN(idx) || !list[idx]) { showMsg('Select a saved account to delete.', 'err'); return; }
    list.splice(idx,1);
    saveAccounts(list);
    refreshAccountSelect();
    showMsg('Account removed.', 'ok');
  });

  // Fetch UI events
  document.getElementById('btnFetch').onclick = () => fetchEmails(false);
  document.getElementById('btnRefresh').onclick = () => fetchEmails(true);
  document.getElementById('btnImportant').onclick = () => { view = cache.filter(e => (e.importance||'').toLowerCase()==='important'); page=1; render(); };
  document.getElementById('btnAll').onclick = () => { view = cache.slice(); page=1; render(); };
  document.getElementById('btnExportJson').onclick = () => exportJson(getSelected());
  document.getElementById('btnExportCsv').onclick = () => exportCsv(getSelected());
  document.getElementById('btnSendSelected').onclick = sendSelectedToGenerator;
  document.getElementById('prev').onclick = () => { if (page>1){ page--; render(); } };
  document.getElementById('next').onclick = () => { if (page < Math.max(1, Math.ceil(view.length/pageSize))){ page++; render(); } };
  pageSizeSel.onchange = () => { pageSize = Number(pageSizeSel.value||20); page=1; render(); };

  // Helpers
  function showMsg(text, type='err'){
    msg.innerHTML = `<div class="alert ${type==='err'?'err':'ok'}">${escapeHtml(text)}</div>`;
    setTimeout(() => { msg.innerHTML=''; }, 4500);
  }
  function skeleton(count=5){
    document.getElementById('listCard').setAttribute('aria-busy','true');
    list.innerHTML = Array.from({length:count}).map(()=>`<div class="sk-card skeleton"></div>`).join('');
  }

  async function fetchEmails(isRefresh){
    const email = getVal('email'), password = getVal('password'), host = getVal('host'), port = Number(getVal('port'));
    const useTls = (tlsToggleSel.value === 'true');
    if (!email || !password || !host || !port){ showMsg('Please fill Email, App Password, Host and Port.'); return; }

    if (!isRefresh) {
      skeleton(6);
      toggleDisabled(true);
    }

    try {
      const sinceMinutes = Number(rangeSel.value || 2880); // default 2 days
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 60000); // 60s
      const res = await fetch(`${API}/fetch`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password, host, port, limit: 200, sinceMinutes, tls: useTls }),
        signal: controller.signal
      });
      clearTimeout(t);

      const data = await res.json().catch(()=>({}));
      if (!res.ok || !data || data.success === false){
        throw new Error(data?.error || `Server error (${res.status})`);
      }

      const items = Array.isArray(data.emails) ? data.emails : (Array.isArray(data) ? data : []);
      const normalized = items.map(normalizeEmail);

      if (isRefresh) {
        let added = 0;
        for (const e of normalized) {
          if (!cache.find(x => String(x.id) === String(e.id))) {
            cache.unshift(e);
            added++;
          }
        }
        if (added) { view = cache.slice(); page = 1; render(); showMsg(`+${added} new email(s).`, 'ok'); }
      } else {
        cache = normalized;
        view = cache.slice();
        page = 1;
        render();
      }

      document.getElementById('listCard').setAttribute('aria-busy','false');
      lastSyncHint.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
      if (!isRefresh) showMsg(`Fetched ${cache.length} email(s).`, 'ok');
    } catch (e){
      document.getElementById('listCard').setAttribute('aria-busy','false');
      if (!isRefresh) list.innerHTML = '';
      showMsg(e.name === 'AbortError' ? 'Request timed out. Please try again.' : (e.message || 'Fetch failed.'));
    } finally {
      if (!isRefresh) toggleDisabled(false);
    }
  }

  function normalizeEmail(e){
    return {
      id: e.id || e.uid || cryptoRandomId(),
      from: e.from || '',
      subject: e.subject || '(no subject)',
      text: e.text || '',
      html: e.html || '',
      date: e.date || e.internalDate || '',
      importance: e.importance || 'unclassified',
      fromEmail: (() => { const m=(e.from||'').match(/<([^>]+)>/); return (m && m[1]) || (e.from||''); })(),
      fromDomain: (() => {
        const fe = ((e.from||'').match(/<([^>]+)>/)||[,''])[1] || (e.from||'');
        return (String(fe).split('@')[1]||'').trim();
      })()
    };
  }

  function cryptoRandomId(){
    if (window.crypto?.getRandomValues){
      const a = new Uint32Array(3); window.crypto.getRandomValues(a);
      return [...a].map(n=>n.toString(16)).join('');
    }
    return String(Date.now())+Math.random().toString(16).slice(2);
  }

  function render(){
    const total = view.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    if (page > pages) page = pages;

    const start = (page-1)*pageSize;
    const slice = view.slice(start, start+pageSize);

    list.innerHTML = slice.map(cardHtml).join('') || `<div class="alert ok">No emails to show.</div>`;
    pageInfo.textContent = `Page ${page} / ${pages}`;
    countInfo.textContent = `${total} email(s) • showing ${slice.length}`;
  }

  function cardHtml(e){
    const fromText = e.from || '';
    const fromEmail = e.fromEmail || ((fromText.match(/<([^>]+)>/) || [,''])[1] || fromText);
    const fromDomain = (e.fromDomain || (fromEmail.split('@')[1] || '')).trim();
    const dateStr = e.date ? new Date(e.date).toLocaleString() : '';
    const pill = (e.importance||'unclassified').toLowerCase()==='important' ? 'tag imp' : 'tag';

    return `
      <div class="email" data-id="${escapeHtml(e.id)}">
        <div class="email-header">
          <input class="sel" type="checkbox" aria-label="select email">
          <div>
            <div class="subject">${escapeHtml(e.subject || '(no subject)')}</div>
            <div class="from">
              ${escapeHtml(fromText)}
              ${fromDomain ? ` • <b>${escapeHtml(fromDomain)}</b>` : ''}
              ${dateStr ? ` • ${escapeHtml(dateStr)}` : ''}
            </div>
          </div>
          <div class="meta">
            <span class="${pill}">${escapeHtml(e.importance||'unclassified')}</span>
            <button class="btn ghost" onclick="sendOneToGenerator('${encodeURIComponent(e.id)}')">Send →</button>
          </div>
        </div>
        <details>
          <summary>Preview</summary>
          <div style="white-space:pre-wrap;margin-top:6px" class="preview">${escapeHtml(e.text || stripHtml(e.html))}</div>
        </details>
      </div>
    `;
  }

  function getSelected(){
    const nodes = [...document.querySelectorAll('.email')];
    return nodes
      .filter(n => n.querySelector('.sel').checked)
      .map(n => view.find(e => String(e.id) === String(n.getAttribute('data-id'))))
      .filter(Boolean);
  }

  function exportJson(rows){
    const data = rows && rows.length ? rows : view;
    if (!data.length){ showMsg('Nothing to export.'); return; }
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    download(blob, `emails_${ts()}.json`);
  }

  function exportCsv(rows){
    const data = rows && rows.length ? rows : view;
    if (!data.length){ showMsg('Nothing to export.'); return; }
    const cols = ['id','from','subject','date','importance','text'];
    const csv = [cols.join(',')]
      .concat(data.map(e => cols.map(c => csvCell(e[c] ?? '')).join(',')))
      .join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    download(blob, `emails_${ts()}.csv`);
  }

  function csvCell(v){
    const s = String(v).replace(/"/g,'""').replace(/\r?\n/g,' ');
    return `"${s}"`;
  }
  function download(blob, name){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function stripHtml(html){ const d=document.createElement('div'); d.innerHTML = html || ''; return d.textContent || d.innerText || ''; }
  function toggleDisabled(state){
    document.querySelectorAll('button,input,select').forEach(el => {
      const keep = ['prev','next','pageSize','range'];
      if (!keep.includes(el.id)) el.disabled = !!state;
    });
  }

  // Expose single-send for per-card button
  window.sendOneToGenerator = (idEnc) => {
    const id = decodeURIComponent(idEnc);
    const e = view.find(x => String(x.id) === String(id));
    if (!e) return showMsg('Email not found.');
    navigateToGenerator(e);
  };

  function sendSelectedToGenerator(){
    const chosen = getSelected();
    if (!chosen.length) return showMsg('Select at least one email.');
    navigateToGenerator(chosen[0]); // first for now
  }

  // Sends params your generator expects; index.html universalPrefill handles from/subject/body
  function navigateToGenerator(e){
    const fromText = e.from || '';
    const fromEmail = e.fromEmail || ((fromText.match(/<([^>]+)>/) || [,''])[1] || fromText);
    const fromName = (fromText.replace(/<[^>]*>/g,'').trim() || fromEmail).trim();

    const params = new URLSearchParams({
      from: fromName || fromEmail,
      subject: (e.subject||'').slice(0,180),
      body: (e.text || stripHtml(e.html) || '').slice(0,8000)
    });
    window.location.href = `/${params.toString() ? '?' + params.toString() : ''}`;
  }

  // Init presets/accounts on load
  refreshAccountSelect();
  providerSel.dispatchEvent(new Event('change'));
})();
</script>
</body>
</html>
