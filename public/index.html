<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartEmail</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .container {
      max-width: 750px;
      margin: 32px auto;
      background: #fff;
      padding: 32px 24px 28px;
      border-radius: 14px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    input, textarea, button, select {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .status-log {
      margin-top: 16px;
      font-size: 0.9rem;
      color: #555;
      background: #eef2f5;
      padding: 10px;
      border-radius: 8px;
    }
    .tier-label {
      margin-top: -8px;
      font-weight: bold;
      color: green;
    }
    .refine {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>SmartEmail</h2>
    <div id="tierDisplay" class="tier-label"></div>

    <input type="email" id="email" placeholder="Enter your email" />
    <textarea id="inputText" rows="3" placeholder="Paste or type your email content"></textarea>
    
    <button id="generateBtn">Generate</button>

    <select id="otherFeatures">
      <option disabled selected>Other Features</option>
      <option value="summarize">Summarize</option>
      <option value="translate">Translate</option>
    </select>

    <textarea id="output" rows="4" placeholder="Output appears here..." readonly></textarea>

    <div class="btn-group">
      <button id="copyBtn">Copy</button>
      <button id="textBtn">Text</button>
      <button id="wordBtn">Word</button>
      <button id="pdfBtn">PDF</button>
    </div>

    <input class="refine" type="text" id="refineInput" placeholder="Refine or change tone, etc..." />
    <button id="enhanceBtn" disabled>Enhance</button>

    <div class="status-log" id="log"></div>
  </div>

  <script>
    const emailInput = document.getElementById('email');
    const inputText = document.getElementById('inputText');
    const generateBtn = document.getElementById('generateBtn');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const textBtn = document.getElementById('textBtn');
    const wordBtn = document.getElementById('wordBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const log = document.getElementById('log');
    const tierDisplay = document.getElementById('tierDisplay');
    const enhanceBtn = document.getElementById('enhanceBtn');
    const refineInput = document.getElementById('refineInput');
    const otherFeatures = document.getElementById('otherFeatures');

    let userTier = 'free';

    function setTierDisplay(tier) {
      tierDisplay.innerText = `Tier: ${tier}`;
      if (tier === 'free') {
        enhanceBtn.disabled = true;
      } else {
        enhanceBtn.disabled = false;
      }
    }

    async function checkLicense(email) {
      log.innerText = "Checking license...";
      const res = await fetch('/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, content: "license-check" })
      });
      const data = await res.json();
      userTier = data.tier || 'free';
      setTierDisplay(userTier);
      log.innerText = `Checking license... Tier: ${userTier}`;
    }

    async function generate(action = 'generate') {
      const email = emailInput.value.trim();
      const content = inputText.value.trim();
      if (!email || !content) return alert('Please enter both email and content.');

      if (userTier === 'free' && action !== 'license-check') {
        log.innerText = "This feature requires an upgrade.";
        return;
      }

      log.innerText = `Sending request to server with action: ${action}`;
      const res = await fetch('/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, content, action })
      });

      const data = await res.json();
      if (res.status !== 200) {
        log.innerText = `Error: ${data.error || 'Unknown issue'}`;
        return;
      }

      output.value = data.reply || '';
      log.innerText = `Reply received and displayed successfully.`;
      enhanceBtn.disabled = (userTier === 'free');
    }

    generateBtn.addEventListener('click', () => generate());
    enhanceBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const content = refineInput.value.trim();
      if (!email || !content) return alert('Enter email and refine input.');
      generate('enhance');
    });

    otherFeatures.addEventListener('change', () => {
      const selected = otherFeatures.value;
      if (selected === 'summarize' || selected === 'translate') {
        generate(selected);
      }
      otherFeatures.selectedIndex = 0;
    });

    copyBtn.onclick = () => navigator.clipboard.writeText(output.value);
    textBtn.onclick = () => downloadFile(output.value, 'response.txt');
    wordBtn.onclick = () => downloadFile(output.value, 'response.doc');
    pdfBtn.onclick = () => downloadFile(output.value, 'response.pdf');

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = () => {
      const savedEmail = localStorage.getItem('email');
      if (savedEmail) {
        emailInput.value = savedEmail;
        checkLicense(savedEmail);
      }
      emailInput.addEventListener('change', () => {
        localStorage.setItem('email', emailInput.value.trim());
        checkLicense(emailInput.value.trim());
      });
    };
  </script>
</body>
</html>
