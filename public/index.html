<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SmartEmail | AI Email Generator</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <link rel="icon" type="image/png" href="/favicon.png" />
<style>
  body { font-family: 'Segoe UI', sans-serif; background:#f4f4f4; margin:0; padding:40px 20px; color:#333; }
  .container { max-width:750px; margin:32px auto; background:#fff; padding:32px 24px 28px; border-radius:14px; box-shadow:0 0 12px rgba(0,0,0,.09); }
  #tierBadge { float:right; background:#eee; color:#888; font-weight:700; padding:6px 16px; border-radius:20px; margin-left:10px; border:2px solid #bbb; font-size:15px; letter-spacing:.5px; }
  #tierBadge.pro{ background:#e3f1ff; color:#1976d2; border-color:#1976d2; }
  #tierBadge.premium{ background:#fffbe3; color:#c79a0b; border-color:#c79a0b; }
  h2 { font-size:1.3rem; margin:0 0 16px; font-weight:600; letter-spacing:.2px; }
  .container > div[style*="margin-bottom"] { margin-bottom:26px !important; }
  button, .modal-card button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-size:15px; margin:7px 8px 0 0; font-family:inherit; transition:background .15s; }
  button:disabled { opacity:.56 !important; cursor:not-allowed !important; }

  /* === Modal overlay background === */
  .modal-bg {
    display:none;
    position:fixed;
    inset:0;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.45);
    z-index:2000;
  }

  /* === Modal card base === */
  .modal-card {
    background:#fff;
    border-radius:12px;
    padding:24px 20px;
    max-width:520px;
    width:90%;
    box-shadow:0 6px 32px rgba(0,0,0,.25);
    transform:translateY(6px);
    animation: rc-pop .18s ease-out;
  }
  @keyframes rc-pop {
    from { opacity:0; transform:translateY(12px); }
    to   { opacity:1; transform:translateY(0); }
  }

  .form-row { margin-bottom:14px; display:flex; flex-direction:column; }
  .form-row label { margin-bottom:6px; font-size:15px; font-weight:500; }
  .form-row input[type="text"], .form-row input[type="number"], .form-row textarea, .form-row select {
    font-size:15px; padding:9px 11px; border-radius:6px; border:1px solid #bfc9d1; outline:none; transition:border .15s; background:#f9f9f9;
  }
  .form-row input[type="text"]:focus, .form-row input[type="number"]:focus, .form-row textarea:focus, .form-row select:focus { border:1.5px solid #1976d2; background:#fff; }
  textarea { min-height:36px; resize:vertical; }
  #logo-preview img, #image-preview img { max-height:92px; margin:4px 10px 6px 0; border-radius:6px; }
  #output-container { display:none; margin-top:32px; background:#f9f9f9; border-left:4px solid #4CAF50; padding:20px 20px 14px 24px; white-space:pre-wrap; font-size:15px; border-radius:8px; box-shadow:0 2px 10px rgba(80,110,70,.04); }
  #export-buttons { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 7px; }
  #char-count { margin-top:12px; font-size:13px; color:#555; }
  #debugLog { width:100%; min-height:70px; font-family:monospace; font-size:13px; color:#333; margin-top:18px; border-radius:6px; padding:7px; border:1px solid #ccc; background:#fafafa; }

  /* ============================
     Reply Confirmation refinements
     ============================ */

  /* Card layout */
  .rc-card { padding:22px 22px 16px; }
  .rc-head { margin-bottom:12px; }
  .rc-head h3 { margin:0; font-size:18px; font-weight:700; letter-spacing:.2px; color:#1f2937; }

  /* Grid for fields: From / To side-by-side on wide screens */
  .rc-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px 14px;
    margin-bottom:8px;
  }
  /* Make Subject and Body span both columns */
  #rc_subject, label[for="rc_subject"],
  #rc_body,    label[for="rc_body"] {
    grid-column: 1 / -1;
  }

  /* Inputs */
  .rc-input,
  .rc-textarea {
    width:100%;
    box-sizing:border-box;
    border:1px solid #bfc9d1;
    background:#f9fafb;
    border-radius:8px;
    padding:10px 12px;
    font-size:15px;
    outline:none;
    transition:border .15s, background .15s;
  }
  .rc-input:focus, .rc-textarea:focus {
    background:#fff;
    border-color:#1976d2;
    box-shadow:0 0 0 2px rgba(25,118,210,.12);
  }
  .rc-readonly {
    background:#f3f5f8;
    color:#4b5563;
  }

  /* Bigger, more legible body area */
  .rc-textarea {
    min-height:260px;
    line-height:1.45;
    white-space:pre-wrap;
    resize:vertical;
  }

  /* Footer: status + actions aligned */
  .rc-footer { margin-top:6px; }
  .rc-status { font-size:13px; color:#6b7280; min-height:18px; margin:6px 0 10px; }
  .rc-actions { display:flex; justify-content:flex-end; gap:10px; }

  .rc-btn {
    padding:10px 14px;
    border-radius:8px;
    font-size:14px;
    border:1px solid transparent;
    background:#f3f4f6;
  }
  .rc-btn:hover { background:#e5e7eb; }
  .rc-btn-ghost { background:#f3f4f6; }
  .rc-btn-primary {
    background:#1976d2;
    color:#fff;
  }
  .rc-btn-primary:hover { background:#1869bb; }

  /* Mobile: stack fields cleanly */
  @media (max-width:700px){
    .container{max-width:98vw; padding:13vw 2vw 7vw; border-radius:0;}
    h2{font-size:1.07rem;}
    .form-row input, .form-row textarea, .form-row select{font-size:16px;}
    button, .modal-card button{font-size:15px;}
    .rc-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
    <a href="/imap.html" class="switch-btn">Switch to SmartEmail IMAP</a>
<div class="container">
  <span id="tierBadge">Free Tier</span>
  <h2>üè° SmartEmail ‚Äì AI Email Generator</h2>

  <div style="margin-bottom:18px">
    <button onclick="showBuyPro()" style="background:#1976d2;color:white;">Buy Pro (Monthly)</button>
    <button onclick="showBuyPremium()" style="background:#7c9ab0;color:white;">Buy Premium (Annual)</button>
    <button onclick="clearLicense()" style="background:#8e2424;color:white;">Clear License</button>
    <button onclick="showLicenseEntry()" style="background:#1976d2;color:white;">Enter License Key</button>
    <button onclick="recheckLicense()" style="background:#8bc34a;color:white;">Recheck License</button>
  </div>

  <!-- Email Modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal-card">
      <label for="emailInput">Enter your email to unlock features:</label>
      <p style="margin:4px 0 12px 0; color:#888; font-size:13px;">
        Your email is used only to activate your free license. We never sell or share your information.
        <span style="text-decoration:underline; cursor:pointer;" onclick="showLegal('privacy')">Privacy Policy</span>
      </p>
      <input type="email" id="emailInput" placeholder="you@example.com" autocomplete="email" style="margin-bottom:12px;" />
      <button id="continueBtn">Continue</button>
      <div id="statusMsg" style="margin-top:10px; color:#666; font-size:14px;"></div>
    </div>
  </div>

  <!-- Manual License Modal -->
  <div id="licenseModalBg" class="modal-bg">
    <div class="modal-card">
      <label for="licenseInput">Enter License Key:</label>
      <input type="text" id="licenseInput" placeholder="xxxx-xxxx-xxxx-xxxx" maxlength="32" autocomplete="off"/>
      <button onclick="saveLicense()">Submit</button>
      <button onclick="hideLicenseEntry()" style="background:#aaa;">Cancel</button>
    </div>
  </div>

  <!-- ‚úÖ SmartEmail Form Fields -->
  <div class="form-row">
    <label for="audience">Target Audience</label>
    <select id="audience">
      <option value="">Select Audience</option>
      <option value="Customers">Customers</option>
      <option value="Leads">Leads</option>
      <option value="Partners">Partners</option>
      <option value="Employees">Employees</option>
      <option value="Vendors">Vendors</option>
    </select>
  </div>

  <div class="form-row">
    <label for="purpose">Email Purpose</label>
    <select id="purpose">
      <option value="">Select Purpose</option>
      <option value="Welcome">Welcome</option>
      <option value="Reminder">Reminder</option>
      <option value="Promotion">Promotion</option>
      <option value="Follow-up">Follow-up</option>
      <option value="Apology">Apology</option>
    </select>
  </div>

  <div class="form-row">
    <label for="tone">Tone</label>
    <select id="tone">
      <option value="">Select Tone</option>
      <option value="Friendly">Friendly</option>
      <option value="Professional">Professional</option>
      <option value="Urgent">Urgent</option>
      <option value="Empathetic">Empathetic</option>
      <option value="Direct">Direct</option>
    </select>
  </div>

  <div class="form-row">
    <label for="language">Language</label>
    <select id="language">
      <option value="English" selected>English</option>
      <option value="Italian">Italian</option>
      <option value="Spanish">Spanish</option>
      <option value="French">French</option>
      <option value="German">German</option>
    </select>
  </div>

  <div class="form-row">
    <label for="email">Your Email Address</label>
    <input id="email" type="email" placeholder="you@example.com" />
  </div>

  <!-- NEW: Subject field -->
  <div class="form-row">
    <label for="subject">Subject (optional)</label>
    <input id="subject" type="text" placeholder="Subject of your reply" />
  </div>

  <div class="form-row">
    <label for="formality">Formality</label>
    <select id="formality">
      <option value="">Select</option>
      <option>Casual</option><option>Neutral</option><option>Formal</option>
    </select>
  </div>
  <div class="form-row">
    <label for="length">Preferred Length</label>
    <select id="length">
      <option value="">Select</option>
      <option>Under 75 words</option><option>~150 words</option><option>~300 words</option>
    </select>
  </div>
  <div class="form-row">
    <label for="audience_role">Audience Role</label>
    <select id="audience_role">
      <option value="">Select</option>
      <option>Founder</option><option>CFO</option><option>Procurement</option><option>HR</option><option>IT</option><option>Sales</option>
      <option>New customer</option><option>Returning customer</option><option>VIP</option>
    </select>
  </div>

  <div class="form-row">
    <label for="email_content">Email Content</label>
    <textarea id="email_content" placeholder="Paste or type your email content here..."></textarea>
  </div>

  <div class="form-row">
    <label for="sender_details">Email Signature</label>
    <textarea id="sender_details" placeholder="e.g. Jane Doe&#10;Sales Director&#10;jane@example.com"></textarea>
  </div>

  <div class="form-row">
    <label for="action">Desired Outcome</label>
    <input id="action" type="text" placeholder="e.g. Book a call, Visit our site" />
  </div>

  <div class="form-row">
    <label for="logoFile">Upload Logo (Max 2MB)</label>
    <input type="file" id="logoFile" accept="image/*" />
  </div>
  <div id="logo-preview"></div>

  <div class="form-row">
    <label for="images">Upload Additional Images (Max 3, 2MB each)</label>
    <input type="file" id="images" accept="image/*" multiple />
  </div>
  <div id="image-preview"></div>

  <div class="form-row">
    <button id="generateBtn" style="background:#1976d2;color:white;font-size:18px;padding:16px 32px;border-radius:9px;font-weight:bold;width:100%;">Generate Email</button>
  </div>

  <div id="output-container">
    <h3>Generated Email:</h3>
    <div id="result"></div>
    <div id="char-count"></div>
    <div id="export-buttons">
      <button id="copyBtn" onclick="copyToClipboard()">Copy</button>
      <button id="exportBtn" class="proOnly" onclick="exportToWord()" title="Upgrade to Pro to enable this feature">Export Word</button>
      <button id="exportPdfBtn" class="proOnly" onclick="exportToPDF_Instant()" title="Upgrade to Pro to enable this feature">Export PDF</button>
      <button id="exportTextBtn" class="proOnly" onclick="exportToText()" title="Upgrade to Pro to enable this feature">Export Text</button>
      <button onclick="clearAll()">Clear</button>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 4px;">
      <button id="replyGeneratedBtn" style="background:#1976d2;color:#fff;">Reply to Sender (with Generated)</button>
    </div>
   <!-- =========================
     Reply Confirmation Modal
     ========================= -->
<div id="replyConfirmModal" class="modal-bg" style="display:none;">
  <div class="modal-card rc-card" role="dialog" aria-modal="true" aria-labelledby="rc_title">
    <div class="rc-head">
      <h3 id="rc_title">Confirm Reply</h3>
    </div>

    <div class="rc-grid">
      <label for="rc_from">From</label>
      <input id="rc_from" type="email" readonly class="rc-input rc-readonly"/>

      <label for="rc_to">To</label>
      <input id="rc_to" type="email" class="rc-input"/>

      <label for="rc_subject">Subject</label>
      <input id="rc_subject" type="text" class="rc-input"/>

      <label for="rc_body">Body</label>
      <textarea id="rc_body" class="rc-textarea" rows="12" spellcheck="false"></textarea>
    </div>

    <div class="rc-footer">
      <div id="rc_status" class="rc-status" aria-live="polite"></div>
      <div class="rc-actions">
        <button id="rc_cancel" class="rc-btn rc-btn-ghost" type="button">Cancel</button>
        <button id="rc_send" class="rc-btn rc-btn-primary" type="button">Send Reply</button>
      </div>
    </div>
  </div>
</div>
</div>
    <label>Enhance or Correct Listing (Optional)</label>
    <textarea id="enhance" placeholder="e.g. Fix spelling, add more detail about garden..." rows="5" style="width:100%; font-size:16px; min-height:90px;"></textarea>
    <button id="enhanceBtn" class="proOnly" style="background:#4CAF50;color:white;font-size:17px;font-weight:bold;padding:14px 30px;border-radius:9px;margin-top:8px;width:100%;">Enhance Listing</button>
  </div>

  <textarea id="debugLog" readonly placeholder="Debug log will appear here..."></textarea>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ================= LICENSE / TIER ================= */
function showCheckingModal(msg="Checking..."){
  let m=document.createElement('div'); m.id="checkingModal"; Object.assign(m.style,{position:"fixed",zIndex:2000,left:0,top:0,width:"100%",height:"100%",background:"rgba(30,30,30,.4)"});
  m.innerHTML=`<div style="background:#fff;padding:36px 36px 18px;border-radius:14px;max-width:340px;margin:120px auto;box-shadow:0 6px 30px rgba(0,0,0,.18);text-align:center;">
    <div style="font-size:18px;margin-bottom:18px">${msg}</div><button onclick="hideModal()" style="background:#aaa;padding:8px 22px;">Close</button></div>`;
  document.body.appendChild(m);
}
function hideModal(){ let m=document.getElementById('checkingModal'); if(m) m.remove(); }
async function detectAndSyncLicense(showPromptIfFree=true){
  let licenseKey=localStorage.getItem("licenseKey"); let userEmail=localStorage.getItem("userEmail"); let triedEmail=false;
  if(licenseKey){ showCheckingModal("Checking license key..."); try{ const r=await fetch(`/validate-license?licenseKey=${encodeURIComponent(licenseKey)}`); const d=await r.json(); hideModal();
    if (d.tier && d.status === "active") {
      setTier(d.tier);
      updateFeatureAccess();
      if (d.licenseKey) localStorage.setItem("licenseKey", d.licenseKey);
      if (d.email)      localStorage.setItem("userEmail",  d.email);
      log("‚úÖ Loaded license via key.");
      if (String(d.tier).toLowerCase() === "free" && showPromptIfFree) { showEmailPrompt(); }
      return;
    } else { localStorage.removeItem("licenseKey"); triedEmail=true; log("‚ùå Bad/expired key."); } }catch(e){ hideModal(); log("‚ùå License check failed: "+e.message); } }
  if(userEmail&&!triedEmail){ showCheckingModal("Checking for license linked to your email..."); try{ const r=await fetch(`/validate-license?email=${encodeURIComponent(userEmail)}`); const d=await r.json(); hideModal();
    if (d.tier && d.status === "active") {
      setTier(d.tier);
      updateFeatureAccess();
      if (d.licenseKey) localStorage.setItem("licenseKey", d.licenseKey);
      if (d.email)      localStorage.setItem("userEmail",  d.email);
      log("‚úÖ Loaded license via email.");
      if (String(d.tier).toLowerCase() === "free" && showPromptIfFree) { showEmailPrompt(); }
      return;
    } else { localStorage.removeItem("userEmail"); log("‚ùå Email not licensed."); } }catch(e){ hideModal(); log("‚ùå Email license check failed: "+e.message); } }
  setTier("free"); updateFeatureAccess(); log("üë§ No license found; set free."); if(showPromptIfFree) showEmailPrompt();
}
function showEmailPrompt(){ document.getElementById('modalBg').style.display='block'; }
function hideEmailPrompt(){ document.getElementById('modalBg').style.display='none'; }
function showLicenseEntry(){ document.getElementById('licenseInput').value=""; document.getElementById('licenseModalBg').style.display='block'; }
function hideLicenseEntry(){ document.getElementById('licenseModalBg').style.display='none'; }
document.getElementById("continueBtn").onclick=async function(){
const emailInput=document.getElementById("emailInput"); const hiddenEmailField=document.getElementById("email"); const statusMsg=document.getElementById("statusMsg"); const btn=this;
  if(!emailInput||!btn) return; btn.disabled=true; btn.innerText="Processing...";
  let email=emailInput.value.trim(); if(!email){ email=localStorage.getItem("userEmail")?.trim()||""; if(email) emailInput.value=email; }
  const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!re.test(email)){ alert("Please enter a valid email address."); btn.disabled=false; btn.innerText="Continue"; return; }
  localStorage.setItem("userEmail",email); if(hiddenEmailField) hiddenEmailField.value=email;
  try{ await syncTierFromSQL(email); }catch(_){}
  try {
    const res = await fetch("/api/register-free-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });
    await res.json().catch(() => ({}));
  } catch (e) {
    const msg = String(e?.message || '').toLowerCase();
    if (!msg.includes("duplicate") && !msg.includes("pattern") && !msg.includes("did not match")) {
      alert("Something went wrong while saving your email. Please try again.");
    }
  }
  hideEmailPrompt();
  setTimeout(()=>{ if(statusMsg) statusMsg.innerText="üîç Checking license (post-registration)..."; log("üì° Post-reg license check."); detectAndSyncLicense(false); },700);
  btn.disabled=false; btn.innerText="Continue";
};
function maskLicense(k){ if(!k||k.length<4) return'xxxx'; return'xxxx-xxxx-xxxx-'+k.slice(-4); }
async function saveLicense(){
  const key=document.getElementById("licenseInput").value.trim(); if(!key) return alert("‚ùó Please enter a license key.");
  localStorage.setItem("licenseKey",key); log("üîë Saved key locally: "+maskLicense(key)); showCheckingModal("Checking license key...");
  try{ const r=await fetch(`/validate-license?licenseKey=${encodeURIComponent(key)}`); const d=await r.json(); hideModal();
    if(d.tier&&d.status==="active"){ setTier(d.tier); updateFeatureAccess(); if(d.licenseKey) localStorage.setItem("licenseKey",d.licenseKey); if(d.email) localStorage.setItem("userEmail",d.email); alert("‚úÖ License applied: "+(d.tier||'free').toUpperCase()); hideLicenseEntry(); }
    else{ localStorage.removeItem("licenseKey"); setTier("free"); updateFeatureAccess(); alert("‚ùå License not recognized or expired."); } }catch(e){ hideModal(); alert("‚ùå Error validating license: "+e.message); }
}
function clearLicense(){ if(!confirm("Clear your license and email?")) return; localStorage.removeItem("licenseKey"); localStorage.removeItem("userEmail"); setTier("free"); updateFeatureAccess(); alert("‚úÖ Cleared. Back to free."); log("üîÑ Cleared license."); }
function setTier(t){ window.userTier=t; const b=document.getElementById("tierBadge"); b.className=''; const v=String(t||'free').toLowerCase(); if(v==="pro") b.classList.add('pro'); else if(v==="premium") b.classList.add('premium'); else b.className=''; b.innerText=(v.charAt(0).toUpperCase()+v.slice(1))+" Tier"; }
function updateFeatureAccess(){
  let t=window.userTier||"free"; let pro=(t==="pro"||t==="premium");
  const ids=[["exportBtn"],["exportPdfBtn"],["exportTextBtn"],["enhanceBtn"]]; ids.forEach(([id])=>{ const el=document.getElementById(id); if(!el) return; el.disabled=!pro; el.style.opacity=pro?"1":"0.5"; el.style.cursor=pro?"pointer":"not-allowed"; });
  const cp=document.getElementById("copyBtn"); if(cp){ cp.disabled=false; cp.style.opacity="1"; cp.style.cursor="pointer"; }
  log("‚úÖ Access updated: "+t);
}
function showBuyPro(){ fetch('/config').then(r=>r.json()).then(d=>{ if(d.PRO_URL) window.open(d.PRO_URL,"_blank"); else alert("Pro purchase URL not found."); }).catch(()=>alert("Failed to load Pro purchase URL.")); }
function showBuyPremium(){ fetch('/config').then(r=>r.json()).then(d=>{ if(d.PREMIUM_URL) window.open(d.PREMIUM_URL,"_blank"); else alert("Premium purchase URL not found."); }).catch(()=>alert("Failed to load Premium purchase URL.")); }
window.onload=function(){ detectAndSyncLicense(); try{ const e=localStorage.getItem('userEmail'); if(e) syncTierFromSQL(e); }catch(_){} };
function recheckLicense(){ detectAndSyncLicense(false); alert("üîÑ License rechecked and access updated."); }
function log(m){ const a=document.getElementById("debugLog"); if(!a) return; a.value+=`${new Date().toISOString()} ‚Äî ${m}\n`; a.scrollTop=a.value.length; if(a.value.length>12000) a.value=a.value.slice(-9000); console.log(m); }

// === SQL-Tier helpers (non-blocking) ===
async function sqlCheckEmail(email) {
  const licenseKey = (localStorage.getItem('licenseKey') || '').trim();
  const res = await fetch('/api/license/check', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, licenseKey })
  });
  if (!res.ok) throw new Error('Lookup failed');
  return await res.json();
}
async function syncTierFromSQL(email){
  try{
    const d = await sqlCheckEmail(email);
    const tier = (d && d.active && d.tier) ? d.tier : 'free';
    localStorage.setItem('smartemail_tier', tier);
    setTier(tier);
    updateFeatureAccess();
    log && log(`üîÑ SQL tier sync: ${tier} for ${email}`);
  }catch(e){
    log && log('‚ö†Ô∏è SQL sync failed: '+(e?.message||'error'));
  }
}
/* ================= END LICENSE ================= */

/* ================= GENERATE / ENHANCE ================= */
window.logoImageBase64=""; window.propertyImagesBase64=[];
async function generate(){
  const email=(localStorage.getItem("userEmail")?.trim()||document.getElementById("email").value.trim());
  const emailType=document.getElementById("purpose").value.trim();
  const tone=document.getElementById("tone").value.trim();
  const language=document.getElementById("language").value.trim();
  const audience=document.getElementById("audience").value.trim();
  const content=document.getElementById("email_content").value.trim();
  const agent=document.getElementById("sender_details").value.trim();
  const action=document.getElementById("action").value.trim();

  if(!email||!emailType||!tone||!language||!audience||!content){ alert("Please complete all required fields including your email and content."); return; }
  log("üìß Generating email for: "+email+" | Purpose: "+emailType);

  const formalityEl     = document.getElementById('formality');
  const lengthEl        = document.getElementById('length');
  const audienceRoleEl  = document.getElementById('audience_role');
  const formalityOpt    = (formalityEl && formalityEl.value) ? formalityEl.value.trim() : "";
  const lengthPrefOpt   = (lengthEl && lengthEl.value) ? lengthEl.value.trim() : "";
  const audienceRoleOpt = (audienceRoleEl && audienceRoleEl.value) ? audienceRoleEl.value.trim() : "";

  try{
    const payload = { email, emailType, tone, language, audience, content, agent, action };
    if (formalityOpt)    payload.formality     = formalityOpt;
    if (lengthPrefOpt)   payload.length        = lengthPrefOpt;
    if (audienceRoleOpt) payload.audience_role = audienceRoleOpt;

    const res = await fetch("/generate",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const data = await res.json();
    if(data.error){ alert("Error: "+data.error); log("‚ùå "+data.error); return; }

    document.getElementById("result").textContent=data.generatedEmail;
    document.getElementById("char-count").textContent=`Character count: ${data.generatedEmail.length}`;
    document.getElementById("output-container").style.display="block";
    document.getElementById("output-container").scrollIntoView({behavior:"smooth"});
    log("‚úÖ Email generated successfully.");
  }catch(e){ console.error(e); log("‚ùå Network/server error."); }
}

async function applyEnhancement(){
  let emailEl=document.getElementById("email"); let email=(emailEl?.value?.trim()||"");
  let tier=(window.userTier||"").toLowerCase(); if(tier!=="pro"&&tier!=="premium"){ alert("‚ùå Enhancement is only available for Pro and Premium users."); return; }
  if(!email){ email=localStorage.getItem("userEmail")?.trim()||""; if(email&&emailEl) emailEl.value=email; }
  const enhance_request=document.getElementById("enhance").value.trim(); const enhance_content=document.getElementById("result").textContent.trim();
  if(!enhance_request){ alert("Please enter an enhancement request."); return; }
  if(!enhance_content||!email){ alert("Missing original content or email address."); return; }
  log("üìù Applying enhancement: "+enhance_request);
  try{
    const res=await fetch("/enhance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,enhance_request,enhance_content})});
    const data=await res.json(); if(data.error){ alert("‚ùå "+data.error); log("‚ùå Enhance failed: "+data.error); return; }
    const updated=data.result||data.generatedEmail||enhance_content;
    document.getElementById("result").textContent=updated;
    document.getElementById("char-count").textContent=`Character count: ${updated.length}`;
    document.getElementById("enhance").value="";
    document.getElementById("output-container").scrollIntoView({behavior:"smooth"});
    log("‚úÖ Enhancement applied.");
  }catch(e){ alert("An error occurred during enhancement."); console.error(e); }
}
/* ================= EXPORTS / UTIL ================= */
function copyToClipboard(){ const t=document.getElementById("result").textContent; navigator.clipboard.writeText(t).then(()=>alert("‚úÖ Copied to clipboard!")); log("üìã Copied."); }
function exportToText(){ const t=document.getElementById("result").textContent; const cleaned=t.replace(/Logo:.*(\n)?/,''); const blob=new Blob([cleaned],{type:"application/octet-stream"}); triggerDownload(blob,getTimestampFilename("Smartlist_Listing","txt")); log("‚¨áÔ∏è TXT exported."); }
function exportToPDF_Instant(){
  const { jsPDF }=window.jspdf; const raw=document.getElementById("result").textContent;
  const stripped=raw.normalize("NFKD").replace(/[\u0300-\u036f]/g,'').replace(/[^\x00-\x7F]/g,''); const doc=new jsPDF();
  let y=20; if(window.logoImageBase64){ doc.addImage(window.logoImageBase64,'PNG',15,10,40,20); y=35; }
  const lines=doc.splitTextToSize(stripped,180); doc.text(lines,15,y); y+=lines.length*10;
  if(window.propertyImagesBase64&&window.propertyImagesBase64.length){ for(const img of window.propertyImagesBase64){ doc.addImage(img,'JPEG',15,y,60,45); y+=50; } }
  doc.save(getTimestampFilename("Smartlist_Listing","pdf")); log("‚¨áÔ∏è PDF exported (client).");
}
function exportToPDF(){
  if(window.userTier==="free"){ alert("‚ùå Export requires Pro or Premium tier."); return; }
  const content=document.getElementById("result").textContent; const logo=window.logoImageBase64||""; const images=window.propertyImagesBase64||[];
  fetch("/export-pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content,logo,images})})
    .then(r=>{ if(!r.ok) throw new Error("PDF export failed"); return r.blob(); })
    .then(b=>{ triggerDownload(b,getTimestampFilename("Smartlist_Listing","pdf")); log("‚¨áÔ∏è PDF exported (server)."); })
    .catch(e=>{ alert("‚ùå PDF export error: "+e.message); log("‚ùå PDF export error: "+e.message); });
}
function exportToWord(){
  if(window.userTier==="free"){ alert("‚ùå Export requires Pro or Premium tier."); return; }
  const content=document.getElementById("result").textContent; const logo=window.logoImageBase64||""; const images=window.propertyImagesBase64||[];
  fetch("/export-word",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content,logo,images})})
    .then(r=>{ if(!r.ok) throw new Error("DOCX export failed"); return r.blob(); })
    .then(b=>{ triggerDownload(b,getTimestampFilename("Smartlist_Listing","docx")); log("‚¨áÔ∏è DOCX exported."); })
    .catch(e=>{ alert("‚ùå DOCX export error: "+e.message); log("‚ùå DOCX export error: "+e.message); });
}
function triggerDownload(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.style.display='none'; a.rel="noopener"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
function clearAll(){ ["audience","purpose","tone","language","email","subject","email_content","sender_details","action","enhance"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  document.getElementById("result").textContent=""; document.getElementById("char-count").textContent=""; document.getElementById("output-container").style.display='none'; log("üßπ Form cleared."); }
document.getElementById("logoFile").addEventListener("change",function(){ const preview=document.getElementById("logo-preview"); preview.innerHTML=""; const file=this.files[0]; if(!file) return;
  if(file.size>2*1024*1024){ alert(`${file.name} exceeds 2MB limit.`); this.value=""; return; }
  const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.src=e.target.result; img.style.maxHeight="60px"; img.style.marginBottom="8px"; img.style.borderRadius="4px"; preview.appendChild(img);
    const del=document.createElement('button'); del.textContent='üóëÔ∏è Delete Logo'; del.onclick=function(){ document.getElementById('logoFile').value=""; document.getElementById('logo-preview').innerHTML=""; window.logoImageBase64=""; }; del.style.marginLeft='10px'; preview.appendChild(del);
    window.logoImageBase64=e.target.result; }; r.readAsDataURL(file); });
document.getElementById("images").addEventListener("change",function(){ const preview=document.getElementById("image-preview"); preview.innerHTML=""; window.propertyImagesBase64=[]; const files=Array.from(this.files);
  if(files.length>3){ alert("Maximum 3 images allowed."); this.value=""; return; }
  files.forEach(file=>{ if(file.size>2*1024*1024){ alert(`${file.name} exceeds 2MB limit.`); this.value=""; preview.innerHTML=""; return; }
    const r=new FileReader(); r.onload=e=>{ const base64=e.target.result; window.propertyImagesBase64.push(base64); const img=new Image(); img.src=e.target.result; img.style.maxHeight="100px"; img.style.marginRight="10px"; img.style.borderRadius="6px";
      const wrap=document.createElement('div'); wrap.style.display='inline-block'; wrap.style.position='relative'; const del=document.createElement('button'); del.textContent='üóëÔ∏è'; del.style.position='absolute'; del.style.top='0'; del.style.right='0';
      del.style.background='red'; del.style.color='white'; del.style.border='none'; del.style.borderRadius='50%'; del.style.cursor='pointer'; del.onclick=function(){ wrap.remove(); };
      wrap.appendChild(img); wrap.appendChild(del); preview.appendChild(wrap); }; r.readAsDataURL(file); }); });
function getTimestampFilename(base,ext){ const ts=new Date().toISOString().replace(/[:.]/g,'-'); return `${base}_${ts}.${ext}`; }
/* ================ END CORE JS ================ */

/* =========== Prefill from IMAP URL =========== */
(function universalPrefill(){
  try{
    const qs=new URLSearchParams(window.location.search); if(qs.toString()==='') return;
    const getAny=(keys,def='')=>{ for(const k of keys){ const v=qs.get(k); if(v) return v; } return def; };
    const fromName=getAny(['from','prefill_from_name','prefill_from','sender','sender_name']);
    const fromEmail=getAny(['prefill_from_email','sender_email','email_from']);
    const subject=getAny(['subject','prefill_subject','email_subject']);
    const body=getAny(['body','prefill_body','content','email_content']);
    const when=getAny(['prefill_date','date']);
    const importance=getAny(['prefill_importance','importance']);
    const $=id=>document.getElementById(id); const pick=(...ids)=>ids.map($).find(Boolean);

    const subjectEl=pick('subject','emailSubject','email_subject','email-subject');
    if(subjectEl&&subject){ subjectEl.value=subject; subjectEl.dispatchEvent(new Event('input',{bubbles:true})); subjectEl.dispatchEvent(new Event('change',{bubbles:true})); }

    const audienceEl=pick('target_audience','audience');
    if(audienceEl&&!audienceEl.value){ audienceEl.value=fromName||fromEmail||'Original sender'; audienceEl.dispatchEvent(new Event('change',{bubbles:true})); }

    const bodyEl=pick('email_content','emailContent','content','context','message','emailText','body');
    if(bodyEl){
      const header=[]; if(fromName||fromEmail) header.push(`> From: ${fromName||fromEmail}${fromEmail?` <${fromEmail}>`:''}`);
      if(when) header.push(`> Date: ${new Date(when).toLocaleString()}`); if(importance) header.push(`> Marked: ${importance}`);
      const prefix=(header.length?header.join('\n')+'\n\n':'')+(subject?`Subject: ${subject}\n\n`:'' );
      bodyEl.value=prefix+(body||''); bodyEl.dispatchEvent(new Event('input',{bubbles:true})); bodyEl.dispatchEvent(new Event('change',{bubbles:true}));
    }
  }catch(e){ console.warn('Prefill skipped:',e); }
})();
</script>


<script>
/* =========== Attach listeners once (fixed) =========== */
document.addEventListener("DOMContentLoaded", () => {
  const generateBtn = document.getElementById("generateBtn");
  const enhanceBtn  = document.getElementById("enhanceBtn");
  if (generateBtn) generateBtn.addEventListener("click", generate);
  if (enhanceBtn)  enhanceBtn.addEventListener("click", applyEnhancement);

  const hasCred = !!(localStorage.getItem("userEmail") || localStorage.getItem("licenseKey"));
  const stored  = hasCred && (
    localStorage.getItem("smartemail_tier") ||
    localStorage.getItem("smartemail.tier") ||
    localStorage.getItem("license_tier")
  );

  if (stored) {
    setTier(stored);
    updateFeatureAccess();
  } else {
    setTier("free");
    updateFeatureAccess();
    showEmailPrompt();
  }
});
</script>

<!-- ========= LEGAL FOOTER & MODALS ========= -->
<footer id="legalFooter" style="margin-top:40px;padding:18px 0 6px 0; text-align:center; background:transparent; color:#888; font-size:13px;">
  <span style="margin:0 12px; cursor:pointer; text-decoration:underline;" onclick="showLegal('privacy')">Privacy Policy</span>
  <span style="margin:0 12px; cursor:pointer; text-decoration:underline;" onclick="showLegal('terms')">Terms of Use</span>
  <span style="margin:0 12px; cursor:pointer; text-decoration:underline;" onclick="showLegal('compliance')">Compliance</span>
  <span style="margin:0 12px; font-style:italic;">Patent Pending</span>
</footer>

<div id="legalModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(25,25,25,0.28); backdrop-filter: blur(1px);">
  <div id="legalBox" style="background:#fff; max-width:580px; margin:6vh auto 0; border-radius:12px; box-shadow:0 8px 42px rgba(0,0,0,0.17); padding:32px 24px 26px; position:relative; color:#263238; font-size:15px; line-height:1.68;">
    <button onclick="hideLegal()" style="position:absolute;top:14px;right:18px;background:#f5f5f5;color:#444;border:none;font-size:15px;padding:5px 14px;border-radius:8px;cursor:pointer;">Close</button>
    <div id="legalContent"></div>
  </div>
</div>
<!-- SMTP Settings Modal -->
<div id="smtpModal" class="modal-bg" style="display:none;">
  <div class="modal-card" style="max-width:420px;">
    <h3 style="margin-top:0;">SMTP Settings</h3>
    <p style="color:#666;margin-top:6px;">Use an app password if your provider requires one.</p>
    <div class="form-row"><label>Host</label><input id="smtp_host" type="text" placeholder="smtp.gmail.com"/></div>
    <div class="form-row"><label>Port</label><input id="smtp_port" type="number" value="465"/></div>
    <div class="form-row"><label>Secure (TLS)</label><select id="smtp_secure"><option value="true" selected>Yes (465)</option><option value="false">No (587)</option></select></div>
    <div class="form-row"><label>Auth Type</label><select id="smtp_authType"><option value="password" selected>Password</option><option value="xoauth2">OAuth2 (Token)</option></select></div>
    <div class="form-row"><label>Email (From)</label><input id="smtp_email" type="email" placeholder="you@example.com"/></div>
    <div class="form-row"><label>Password / App Password</label><input id="smtp_password" type="password"/></div>
    <div class="form-row"><label>Access Token (OAuth2)</label><input id="smtp_accessToken" type="text" placeholder="Optional for OAuth2"/></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button id="smtpSaveBtn" style="background:#1976d2;color:#fff;">Save</button>
      <button id="smtpCancelBtn" style="background:#aaa;">Cancel</button>
    </div>
  </div>
</div>

<script>
  const legalTexts={
    privacy:`<h3 style="margin-top:0">Privacy Policy</h3>
      <p>Your privacy is important. We comply with POPIA, GDPR, CCPA and all global data laws. Only essential info (email, license key) is stored to deliver features and is never sold or used for marketing.</p>
      <ul><li>All data is encrypted in transit and at rest.</li><li>No personal data is shared with third parties except for payment/license verification (e.g., Stripe, Supabase).</li><li>You may request deletion of your account or data any time by emailing <a href="mailto:support@smartmail.store">support@smartmail.store</a>.</li><li>AI outputs are not permanently stored or used to train external models.</li></ul>
      <p>For full details, <a href="mailto:support@smartmail.store">contact us</a>.</p>`,
    terms:`<h3 style="margin-top:0">Terms of Use</h3>
      <ul><li>This service is provided "as is" and may be withdrawn at any time.</li><li>You must not misuse the service, attempt to reverse engineer it, or use it for unlawful activity.</li><li>Paid tiers are delivered on a best effort; refunds for non-delivery will be processed if confirmed.</li><li>AI outputs are for informational use only; we make no guarantee as to accuracy or fitness for any purpose.</li><li>By using this app, you consent to basic data collection (see Privacy Policy).</li><li>All IP, code, and content remain the property of Smartlist. System and Method for Real-Time Multimodal AI Content Generation and Iterative Enhancement ‚Äì Patent Pending (2025/05246).</li></ul>
      <p>If you disagree with these terms, do not use the app. For queries, email <a href="mailto:support@promptagenthq.com">support@promptagenthq.com</a>.</p>`,
    compliance:`<h3 style="margin-top:0">Compliance & Global Notices</h3>
      <ul><li><b>POPIA/POPI (South Africa):</b> We respect your right to privacy and process all personal info lawfully and minimally.</li><li><b>GDPR (EU/UK):</b> Data subjects may request access, correction, or deletion of their data. No profiling or automated decisions.</li><li><b>CCPA (California):</b> California residents have the right to opt out of data sharing and request deletion.</li><li><b>AI Output Notice:</b> Listings are AI-generated and may contain errors or bias. Use at your own discretion.</li><li>For any privacy or compliance request, contact: <a href="mailto:support@promptagenthq.com">support@promptagenthq.com</a></li></ul>`
  };
  function showLegal(which){ document.getElementById('legalContent').innerHTML=legalTexts[which]||''; document.getElementById('legalModal').style.display='block'; document.body.style.overflow='hidden'; }
  function hideLegal(){ document.getElementById('legalModal').style.display='none'; document.body.style.overflow=''; }
</script>

<script>
// === Runtime Advanced wrapper (dedupe-safe) ===
(function(){
  try{
    document.querySelectorAll('details#advancedRefinements').forEach(el => el.remove());
    const f = document.getElementById('formality');
    const l = document.getElementById('length');
    const a = document.getElementById('audience_role');
    if(!f && !l && !a) return;

    const details = document.createElement('details');
    details.id = 'advancedRefinements';
    details.style.margin = '12px 0';
    const summary = document.createElement('summary');
    summary.textContent = 'Advanced (optional)';
    summary.style.cursor = 'pointer';
    summary.style.fontWeight = '600';
    details.appendChild(summary);

    const inner = document.createElement('div');
    inner.style.display = 'flex';
    inner.style.gap = '12px';
    inner.style.flexWrap = 'wrap';
    inner.style.marginTop = '8px';
    details.appendChild(inner);

    function moveFieldById(id, labelText){
      const el = document.getElementById(id);
      if(!el) return;
      let container = el.closest('label, .form-group, .row, .col, div') || el;
      if(container === el && !el.closest('label')){
        const wrap = document.createElement('label');
        wrap.style.flex = '1 1 220px';
        wrap.style.minWidth = '220px';
        wrap.textContent = labelText + ' ';
        el.parentNode.insertBefore(wrap, el);
        wrap.appendChild(el);
        container = wrap;
      } else {
        container.style.flex = '1 1 220px';
        container.style.minWidth = '220px';
      }
      inner.appendChild(container);
    }
    moveFieldById('formality','Formality');
    moveFieldById('length','Preferred Length');
    moveFieldById('audience_role','Audience Role');

    const insertBeforeBtn = Array.from(document.querySelectorAll('button')).find(b => /generate/i.test(b.textContent||''));
    if(insertBeforeBtn && insertBeforeBtn.parentNode){
      insertBeforeBtn.parentNode.parentNode.insertBefore(details, insertBeforeBtn.parentNode);
    } else {
      const main = document.querySelector('main') || document.body;
      main.appendChild(details);
    }
  }catch(e){ console.warn('Advanced wrapper init failed:', e); }
})();
</script>

<script>
/* ============================================================
   SmartEmail ‚Äì Prefill + Reply Confirmation (PRO, safe)
   - Keeps form prefill working from sessionStorage.imap.generatorPayload
   - Opens a confirmation modal with From/To/Subject/Body ready
   - Sends to /api/imap/send with inReplyTo + references (threading)
   - Defensive: no-throws, null-safe, minimal global surface
   ============================================================ */

(function () {
  "use strict";

  /* ---------- tiny helpers ---------- */
  const get = (id) => /** @type {HTMLInputElement|HTMLTextAreaElement|null} */(document.getElementById(id));
  const val = (el) => (el && "value" in el) ? String(el.value || "").trim() : "";
  const set = (el, v) => { if (el && "value" in el) el.value = v ?? ""; };

  /* ---------- 1) Prefill the main generator form ---------- */
  (function prefillMainFormFromIMAP() {
    let payload = null;
    try { payload = JSON.parse(sessionStorage.getItem("imap.generatorPayload") || "null"); } catch {}
    if (!payload) return;

    // subject ‚Üí #subject
    if (payload.subject && get("subject")) set(get("subject"), payload.subject);

    // body/snippet ‚Üí #email_content
    const bodyText = payload.body || payload.snippet || "";
    if (bodyText && get("email_content")) set(get("email_content"), bodyText);

    // mailbox owner (the *recipient* of the original message) ‚Üí #email
    if (payload.toEmail && get("email")) set(get("email"), payload.toEmail);

    // Optional: clear payload once used
    
  })();

  /* ---------- 2) Reply Confirmation Modal wiring ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    const replyBtn = get("replyGeneratedBtn");
    const modal = document.getElementById("replyConfirmModal");
    if (!replyBtn || !modal) return;

    // Open modal with context
    replyBtn.addEventListener("click", () => {
      let ctx = {};
      try { ctx = JSON.parse(sessionStorage.getItem("imap.generatorPayload") || "{}"); } catch {}

      const owner =
        localStorage.getItem("userEmail") ||
        localStorage.getItem("imap.email") ||
        localStorage.getItem("smartemail.imapEmail") ||
        val(get("email")) ||
        "";

      // Fill modal fields
      set(get("rc_from"), owner);
      set(get("rc_to"),   ctx.fromEmail || "");
      set(get("rc_subject"), ctx.subject || "");
      set(get("rc_body"),
          (document.getElementById("result")?.textContent || "").trim());

      // Save threading context
      try {
        modal.dataset.ctx = JSON.stringify({
          messageId : ctx.messageId || null,
          references: Array.isArray(ctx.references) ? ctx.references : []
        });
      } catch {}

      modal.style.display = "flex";
    });

    // Cancel closes modal
    const cancelBtn = document.getElementById("rc_cancel");
    if (cancelBtn) cancelBtn.onclick = () => { modal.style.display = "none"; };

    // ---------- Send handler ----------
    const sendBtn = document.getElementById("rc_send");
    if (sendBtn) sendBtn.onclick = async () => {
      const statusEl = document.getElementById("rc_status");

      const from = val(get("rc_from"));
      const to   = val(get("rc_to"));
      let subj   = val(get("rc_subject"));
      if (!subj) {
        const resultText = document.getElementById("result")?.textContent || "";
        const m = resultText.match(/^Subject:\s*(.+)$/mi);
        if (m && m[1]) subj = m[1].trim();
      }
      const body  = val(get("rc_body"));

   // SMTP details: use modal inputs first, then localStorage fallback
const smtp = {
  host:        val(get("smtp_host"))        || localStorage.getItem("smtp_host")        || "smtp.gmail.com",
  port:        Number(val(get("smtp_port")) || localStorage.getItem("smtp_port")        || "465"),
  email:       val(get("smtp_email"))       || localStorage.getItem("smtp_email")       || from,
  password:    val(get("smtp_password"))    || localStorage.getItem("smtp_password")    || "",
  accessToken: val(get("smtp_accessToken")) || localStorage.getItem("smtp_accessToken") || ""
};

      if (!from || !to || !subj || !body) {
        if (statusEl) statusEl.textContent = "‚ùå Missing required fields (from, to, subject, body).";
        return;
      }
      if (!smtp.host || !smtp.email || (!smtp.password && !smtp.accessToken)) {
        if (statusEl) statusEl.textContent = "‚ùå SMTP not ready (need host, email, and password or token).";
        return;
      }

      let extra = {};
      try { extra = JSON.parse(modal.dataset.ctx || "{}"); } catch {}

      if (statusEl) statusEl.textContent = "üì° Sending‚Ä¶";

      let resp, data;
try {
  // build payload once
  const payload = {
    // message fields
    from,
    to,
    subject: subj,
    text: body,

    // threading info
    inReplyTo: extra.messageId || null,
    references: Array.isArray(extra.references) ? extra.references : [],

    // keep nested smtp for newer handler
    smtp,

    // also provide flat SMTP fields for older server handlers
    host: smtp.host,
    port: smtp.port,
    email: smtp.email,
    password: smtp.password || "",
    accessToken: smtp.accessToken || ""
  };

  resp = await fetch("/api/imap/send", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  // parse JSON safely
  data = await resp.json().catch(() => ({}));

  if (!resp.ok || data.ok === false) {
    throw new Error(data.error || `Send failed (${resp.status})`);
  }

  if (statusEl) {
    statusEl.textContent = "‚úÖ Reply sent!";
    setTimeout(() => { modal.style.display = "none"; }, 400);
  }
} catch (e) {
  if (statusEl) statusEl.textContent = "‚ùå Error: " + (e?.message || e);
}
    };
  });
})();
</script>

</body>
</html>
