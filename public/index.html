<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SmartEmail | AI Email Generator</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <link rel="icon" type="image/png" href="/favicon.png" />
<style>
  body { font-family: 'Segoe UI', sans-serif; background:#f4f4f4; margin:0; padding:40px 20px; color:#333; }
  .container { max-width:750px; margin:32px auto; background:#fff; padding:32px 24px 28px; border-radius:14px; box-shadow:0 0 12px rgba(0,0,0,.09); }
  #tierBadge { float:right; background:#eee; color:#888; font-weight:700; padding:6px 16px; border-radius:20px; margin-left:10px; border:2px solid #bbb; font-size:15px; letter-spacing:.5px; }
  #tierBadge.pro{ background:#e3f1ff; color:#1976d2; border-color:#1976d2; }
  #tierBadge.premium{ background:#fffbe3; color:#c79a0b; border-color:#c79a0b; }
  h2 { font-size:1.3rem; margin:0 0 16px; font-weight:600; letter-spacing:.2px; }
  .container > div[style*="margin-bottom"] { margin-bottom:26px !important; }
  button, .modal-card button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-size:15px; margin:7px 8px 0 0; font-family:inherit; transition:background .15s; }
  button:disabled { opacity:.56 !important; cursor:not-allowed !important; }
  .modal-bg { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(30,30,30,.5); backdrop-filter:blur(2px); }
  .modal-card { background:#fff; border-radius:16px; padding:36px 28px 28px; max-width:360px; margin:90px auto 0; position:relative; box-shadow:0 6px 40px rgba(0,0,0,.15); }
  .form-row { margin-bottom:14px; display:flex; flex-direction:column; }
  .form-row label { margin-bottom:6px; font-size:15px; font-weight:500; }
  .form-row input[type="text"], .form-row input[type="number"], .form-row textarea, .form-row select {
    font-size:15px; padding:9px 11px; border-radius:6px; border:1px solid #bfc9d1; outline:none; transition:border .15s; background:#f9f9f9;
  }
  .form-row input[type="text"]:focus, .form-row input[type="number"]:focus, .form-row textarea:focus, .form-row select:focus { border:1.5px solid #1976d2; background:#fff; }
  textarea { min-height:36px; resize:vertical; }
  #logo-preview img, #image-preview img { max-height:92px; margin:4px 10px 6px 0; border-radius:6px; }
  #output-container { display:none; margin-top:32px; background:#f9f9f9; border-left:4px solid #4CAF50; padding:20px 20px 14px 24px; white-space:pre-wrap; font-size:15px; border-radius:8px; box-shadow:0 2px 10px rgba(80,110,70,.04); }
  #export-buttons { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 7px; }
  #char-count { margin-top:12px; font-size:13px; color:#555; }
  #debugLog { width:100%; min-height:70px; font-family:monospace; font-size:13px; color:#333; margin-top:18px; border-radius:6px; padding:7px; border:1px solid #ccc; background:#fafafa; }
  @media (max-width:700px){ .container{max-width:98vw; padding:13vw 2vw 7vw; border-radius:0;} h2{font-size:1.07rem;}
    .form-row input, .form-row textarea, .form-row select{font-size:16px;} button, .modal-card button{font-size:15px;} }
</style>
</head>
<body>
    <a href="/imap.html" class="switch-btn">Switch to SmartEmail IMAP</a>
<div class="container">
  <span id="tierBadge">Free Tier</span>
  <h2>üè° SmartEmail ‚Äì AI Email Generator</h2>

  <div style="margin-bottom:18px">
    <button onclick="showBuyPro()" style="background:#1976d2;color:white;">Buy Pro (Monthly)</button>
    <button onclick="showBuyPremium()" style="background:#7c9ab0;color:white;">Buy Premium (Annual)</button>
    <button onclick="clearLicense()" style="background:#8e2424;color:white;">Clear License</button>
    <button onclick="showLicenseEntry()" style="background:#1976d2;color:white;">Enter License Key</button>
    <button onclick="recheckLicense()" style="background:#8bc34a;color:white;">Recheck License</button>
  </div>

  <!-- Email Modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal-card">
      <label for="emailInput">Enter your email to unlock features:</label>
      <p style="margin:4px 0 12px 0; color:#888; font-size:13px;">
        Your email is used only to activate your free license. We never sell or share your information.
        <span style="text-decoration:underline; cursor:pointer;" onclick="showLegal('privacy')">Privacy Policy</span>
      </p>
      <input type="email" id="emailInput" placeholder="you@example.com" autocomplete="email" style="margin-bottom:12px;" />
      <button id="continueBtn">Continue</button>
      <div id="statusMsg" style="margin-top:10px; color:#666; font-size:14px;"></div>
    </div>
  </div>

  <!-- Manual License Modal -->
  <div id="licenseModalBg" class="modal-bg">
    <div class="modal-card">
      <label for="licenseInput">Enter License Key:</label>
      <input type="text" id="licenseInput" placeholder="xxxx-xxxx-xxxx-xxxx" maxlength="32" autocomplete="off"/>
      <button onclick="saveLicense()">Submit</button>
      <button onclick="hideLicenseEntry()" style="background:#aaa;">Cancel</button>
    </div>
  </div>

  <!-- ‚úÖ SmartEmail Form Fields -->
  <div class="form-row">
    <label for="audience">Target Audience</label>
    <select id="audience">
      <option value="">Select Audience</option>
      <option value="Customers">Customers</option>
      <option value="Leads">Leads</option>
      <option value="Partners">Partners</option>
      <option value="Employees">Employees</option>
      <option value="Vendors">Vendors</option>
    </select>
  </div>

  <div class="form-row">
    <label for="purpose">Email Purpose</label>
    <select id="purpose">
      <option value="">Select Purpose</option>
      <option value="Welcome">Welcome</option>
      <option value="Reminder">Reminder</option>
      <option value="Promotion">Promotion</option>
      <option value="Follow-up">Follow-up</option>
      <option value="Apology">Apology</option>
    </select>
  </div>

  <div class="form-row">
    <label for="tone">Tone</label>
    <select id="tone">
      <option value="">Select Tone</option>
      <option value="Friendly">Friendly</option>
      <option value="Professional">Professional</option>
      <option value="Urgent">Urgent</option>
      <option value="Empathetic">Empathetic</option>
      <option value="Direct">Direct</option>
    </select>
  </div>

  <div class="form-row">
    <label for="language">Language</label>
    <select id="language">
      <option value="English" selected>English</option>
      <option value="Italian">Italian</option>
      <option value="Spanish">Spanish</option>
      <option value="French">French</option>
      <option value="German">German</option>
    </select>
  </div>

  <div class="form-row">
    <label for="email">Your Email Address</label>
    <input id="email" type="email" placeholder="you@example.com" />
  </div>

  <!-- NEW: Subject field -->
  <div class="form-row">
    <label for="subject">Subject (optional)</label>
    <input id="subject" type="text" placeholder="Subject of your reply" />
  </div>
    <!-- Minimal additions -->
    <div class="form-row">
      <label for="formality">Formality</label>
      <select id="formality">
        <option value="">Select</option>
        <option>Casual</option><option>Neutral</option><option>Formal</option>
      </select>
    </div>
    <div class="form-row">
      <label for="length">Preferred Length</label>
      <select id="length">
        <option value="">Select</option>
        <option>Under 75 words</option><option>~150 words</option><option>~300 words</option>
      </select>
    </div>
    <div class="form-row">
      <label for="audience_role">Audience Role</label>
      <select id="audience_role">
        <option value="">Select</option>
        <option>Founder</option><option>CFO</option><option>Procurement</option><option>HR</option><option>IT</option><option>Sales</option>
        <option>New customer</option><option>Returning customer</option><option>VIP</option>
      </select>
    </div>


  <div class="form-row">
    <label for="email_content">Email Content</label>
    <textarea id="email_content" placeholder="Paste or type your email content here..."></textarea>
  </div>

  <div class="form-row">
    <label for="sender_details">Email Signature</label>
    <textarea id="sender_details" placeholder="e.g. Jane Doe&#10;Sales Director&#10;jane@example.com"></textarea>
  </div>

  <div class="form-row">
    <label for="action">Desired Outcome</label>
    <input id="action" type="text" placeholder="e.g. Book a call, Visit our site" />
  </div>

  <div class="form-row">
    <label for="logoFile">Upload Logo (Max 2MB)</label>
    <input type="file" id="logoFile" accept="image/*" />
  </div>
  <div id="logo-preview"></div>

  <div class="form-row">
    <label for="images">Upload Additional Images (Max 3, 2MB each)</label>
    <input type="file" id="images" accept="image/*" multiple />
  </div>
  <div id="image-preview"></div>

  <div class="form-row">
    <button id="generateBtn" style="background:#1976d2;color:white;font-size:18px;padding:16px 32px;border-radius:9px;font-weight:bold;width:100%;">Generate Email</button>
  </div>

  <div id="output-container">
    <h3>Generated Email:</h3>
    <div id="result"></div>
    <div id="char-count"></div>
    <div id="export-buttons">
      <button id="copyBtn" onclick="copyToClipboard()">Copy</button>
      <button id="exportBtn" class="proOnly" onclick="exportToWord()" title="Upgrade to Pro to enable this feature">Export Word</button>
      <button id="exportPdfBtn" class="proOnly" onclick="exportToPDF_Instant()" title="Upgrade to Pro to enable this feature">Export PDF</button>
      <button id="exportTextBtn" class="proOnly" onclick="exportToText()" title="Upgrade to Pro to enable this feature">Export Text</button>
      <button onclick="clearAll()">Clear</button>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 4px;">
  <button id="replyGeneratedBtn" style="background:#1976d2;color:#fff;">Reply to Sender (with Generated)</button>
</div>
    <label>Enhance or Correct Listing (Optional)</label>
    <textarea id="enhance" placeholder="e.g. Fix spelling, add more detail about garden..." rows="5" style="width:100%; font-size:16px; min-height:90px;"></textarea>
    <button id="enhanceBtn" class="proOnly" style="background:#4CAF50;color:white;font-size:17px;font-weight:bold;padding:14px 30px;border-radius:9px;margin-top:8px;width:100%;">Enhance Listing</button>
  </div>

  <textarea id="debugLog" readonly placeholder="Debug log will appear here..."></textarea>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ================= LICENSE / TIER ================= */
function showCheckingModal(msg="Checking..."){
  let m=document.createElement('div'); m.id="checkingModal"; Object.assign(m.style,{position:"fixed",zIndex:2000,left:0,top:0,width:"100%",height:"100%",background:"rgba(30,30,30,.4)"});
  m.innerHTML=`<div style="background:#fff;padding:36px 36px 18px;border-radius:14px;max-width:340px;margin:120px auto;box-shadow:0 6px 30px rgba(0,0,0,.18);text-align:center;">
    <div style="font-size:18px;margin-bottom:18px">${msg}</div><button onclick="hideModal()" style="background:#aaa;padding:8px 22px;">Close</button></div>`;
  document.body.appendChild(m);
}
function hideModal(){ let m=document.getElementById('checkingModal'); if(m) m.remove(); }
async function detectAndSyncLicense(showPromptIfFree=true){
  let licenseKey=localStorage.getItem("licenseKey"); let userEmail=localStorage.getItem("userEmail"); let triedEmail=false;
  if(licenseKey){ showCheckingModal("Checking license key..."); try{ const r=await fetch(`/validate-license?licenseKey=${encodeURIComponent(licenseKey)}`); const d=await r.json(); hideModal();
    if (d.tier && d.status === "active") {
  setTier(d.tier);
  updateFeatureAccess();
  if (d.licenseKey) localStorage.setItem("licenseKey", d.licenseKey);
  if (d.email)      localStorage.setItem("userEmail",  d.email);
  log("‚úÖ Loaded license via key.");

  // Force prompt if still on FREE tier
  if (String(d.tier).toLowerCase() === "free" && showPromptIfFree) {
    showEmailPrompt();
  }
  return;
}
    else{ localStorage.removeItem("licenseKey"); triedEmail=true; log("‚ùå Bad/expired key."); } }catch(e){ hideModal(); log("‚ùå License check failed: "+e.message); } }
  if(userEmail&&!triedEmail){ showCheckingModal("Checking for license linked to your email..."); try{ const r=await fetch(`/validate-license?email=${encodeURIComponent(userEmail)}`); const d=await r.json(); hideModal();
    if(d.tier&&d.status==="active"){ setTier(d.tier); updateFeatureAccess(); if(d.licenseKey) localStorage.setItem("licenseKey",d.licenseKey); if(d.email) localStorage.setItem("userEmail",d.email); log("‚úÖ Loaded license via email."); return; }
    else{ localStorage.removeItem("userEmail"); log("‚ùå Email not licensed."); } }catch(e){ hideModal(); log("‚ùå Email license check failed: "+e.message); } }
  setTier("free"); updateFeatureAccess(); log("üë§ No license found; set free."); if(showPromptIfFree) showEmailPrompt();
}
function showEmailPrompt(){ document.getElementById('modalBg').style.display='block'; }
function hideEmailPrompt(){ document.getElementById('modalBg').style.display='none'; }
function showLicenseEntry(){ document.getElementById('licenseInput').value=""; document.getElementById('licenseModalBg').style.display='block'; }
function hideLicenseEntry(){ document.getElementById('licenseModalBg').style.display='none'; }
document.getElementById("continueBtn").onclick=async function(){
const emailInput=document.getElementById("emailInput"); const hiddenEmailField=document.getElementById("email"); const statusMsg=document.getElementById("statusMsg"); const btn=this;
  if(!emailInput||!btn) return; btn.disabled=true; btn.innerText="Processing...";
  let email=emailInput.value.trim(); if(!email){ email=localStorage.getItem("userEmail")?.trim()||""; if(email) emailInput.value=email; }
  const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!re.test(email)){ alert("Please enter a valid email address."); btn.disabled=false; btn.innerText="Continue"; return; }
  localStorage.setItem("userEmail",email); if(hiddenEmailField) hiddenEmailField.value=email;
  try{ await syncTierFromSQL(email); }catch(_){}
  try {
  const res = await fetch("/api/register-free-user", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });
  await res.json().catch(() => ({}));  // tolerate empty/invalid JSON
} catch (e) {
  const msg = String(e?.message || '').toLowerCase();
  if (
    !msg.includes("duplicate") &&
    !msg.includes("pattern") &&
    !msg.includes("did not match")
  ) {
    alert("Something went wrong while saving your email. Please try again.");
  }
}
  
  hideEmailPrompt();
  setTimeout(()=>{ if(statusMsg) statusMsg.innerText="üîç Checking license (post-registration)..."; log("üì° Post-reg license check."); detectAndSyncLicense(false); },700);
  btn.disabled=false; btn.innerText="Continue";
};
function maskLicense(k){ if(!k||k.length<4) return'xxxx'; return'xxxx-xxxx-xxxx-'+k.slice(-4); }
async function saveLicense(){
  const key=document.getElementById("licenseInput").value.trim(); if(!key) return alert("‚ùó Please enter a license key.");
  localStorage.setItem("licenseKey",key); log("üîë Saved key locally: "+maskLicense(key)); showCheckingModal("Checking license key...");
  try{ const r=await fetch(`/validate-license?licenseKey=${encodeURIComponent(key)}`); const d=await r.json(); hideModal();
    if(d.tier&&d.status==="active"){ setTier(d.tier); updateFeatureAccess(); if(d.licenseKey) localStorage.setItem("licenseKey",d.licenseKey); if(d.email) localStorage.setItem("userEmail",d.email); alert("‚úÖ License applied: "+(d.tier||'free').toUpperCase()); hideLicenseEntry(); }
    else{ localStorage.removeItem("licenseKey"); setTier("free"); updateFeatureAccess(); alert("‚ùå License not recognized or expired."); } }catch(e){ hideModal(); alert("‚ùå Error validating license: "+e.message); }
}
function clearLicense(){ if(!confirm("Clear your license and email?")) return; localStorage.removeItem("licenseKey"); localStorage.removeItem("userEmail"); setTier("free"); updateFeatureAccess(); alert("‚úÖ Cleared. Back to free."); log("üîÑ Cleared license."); }
function setTier(t){ window.userTier=t; const b=document.getElementById("tierBadge"); b.className=''; const v=String(t||'free').toLowerCase(); if(v==="pro") b.classList.add('pro'); else if(v==="premium") b.classList.add('premium'); else b.className=''; b.innerText=(v.charAt(0).toUpperCase()+v.slice(1))+" Tier"; }
function updateFeatureAccess(){
  let t=window.userTier||"free"; let pro=(t==="pro"||t==="premium");
  const ids=[["exportBtn"],["exportPdfBtn"],["exportTextBtn"],["enhanceBtn"]]; ids.forEach(([id])=>{ const el=document.getElementById(id); if(!el) return; el.disabled=!pro; el.style.opacity=pro?"1":"0.5"; el.style.cursor=pro?"pointer":"not-allowed"; });
  const cp=document.getElementById("copyBtn"); if(cp){ cp.disabled=false; cp.style.opacity="1"; cp.style.cursor="pointer"; }
  log("‚úÖ Access updated: "+t);
}
function showBuyPro(){ fetch('/config').then(r=>r.json()).then(d=>{ if(d.PRO_URL) window.open(d.PRO_URL,"_blank"); else alert("Pro purchase URL not found."); }).catch(()=>alert("Failed to load Pro purchase URL.")); }
function showBuyPremium(){ fetch('/config').then(r=>r.json()).then(d=>{ if(d.PREMIUM_URL) window.open(d.PREMIUM_URL,"_blank"); else alert("Premium purchase URL not found."); }).catch(()=>alert("Failed to load Premium purchase URL.")); }
window.onload=function(){ detectAndSyncLicense(); try{ const e=localStorage.getItem('userEmail'); if(e) syncTierFromSQL(e); }catch(_){} };
function recheckLicense(){ detectAndSyncLicense(false); alert("üîÑ License rechecked and access updated."); }
function log(m){ const a=document.getElementById("debugLog"); if(!a) return; a.value+=`${new Date().toISOString()} ‚Äî ${m}\n`; a.scrollTop=a.value.length; if(a.value.length>12000) a.value=a.value.slice(-9000); console.log(m); }

// === SQL-Tier helpers (added, non-blocking; UI unchanged) ===
async function sqlCheckEmail(email) {
  const licenseKey = (localStorage.getItem('licenseKey') || '').trim();
  const res = await fetch('/api/license/check', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, licenseKey })   // <-- include key
  });
  if (!res.ok) throw new Error('Lookup failed');
  return await res.json(); // {found, active, tier}
}
async function syncTierFromSQL(email){
  try{
    const d = await sqlCheckEmail(email);
    const tier = (d && d.active && d.tier) ? d.tier : 'free';
    localStorage.setItem('smartemail_tier', tier);

    // ‚¨áÔ∏è Apply the tier to the UI immediately
    setTier(tier);
    updateFeatureAccess();

    log && log(`üîÑ SQL tier sync: ${tier} for ${email}`);
  }catch(e){
    log && log('‚ö†Ô∏è SQL sync failed: '+(e?.message||'error'));
  }
}
/* === END SQL-Tier helpers === */


/* ================= END LICENSE ================= */

/* ================= GENERATE / ENHANCE ================= */
window.logoImageBase64=""; window.propertyImagesBase64=[];
async function generate(){
  const email=(localStorage.getItem("userEmail")?.trim()||document.getElementById("email").value.trim());
  const emailType=document.getElementById("purpose").value.trim();
  const tone=document.getElementById("tone").value.trim();
  const language=document.getElementById("language").value.trim();
  const audience=document.getElementById("audience").value.trim();
  const content=document.getElementById("email_content").value.trim();
  const agent=document.getElementById("sender_details").value.trim();
  const action=document.getElementById("action").value.trim();

  if(!email||!emailType||!tone||!language||!audience||!content){ alert("Please complete all required fields including your email and content."); return; }
  log("üìß Generating email for: "+email+" | Purpose: "+emailType);

  // Optional refinements (if these fields exist)
  const formalityEl     = document.getElementById('formality');
  const lengthEl        = document.getElementById('length');
  const audienceRoleEl  = document.getElementById('audience_role');
  const formalityOpt    = (formalityEl && formalityEl.value) ? formalityEl.value.trim() : "";
  const lengthPrefOpt   = (lengthEl && lengthEl.value) ? lengthEl.value.trim() : "";
  const audienceRoleOpt = (audienceRoleEl && audienceRoleEl.value) ? audienceRoleEl.value.trim() : "";

  try{
    const payload = { email, emailType, tone, language, audience, content, agent, action };
    if (formalityOpt)    payload.formality     = formalityOpt;
    if (lengthPrefOpt)   payload.length        = lengthPrefOpt;
    if (audienceRoleOpt) payload.audience_role = audienceRoleOpt;

    const res = await fetch("/generate",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const data = await res.json();
    if(data.error){ alert("Error: "+data.error); log("‚ùå "+data.error); return; }

    document.getElementById("result").textContent=data.generatedEmail;
    document.getElementById("char-count").textContent=`Character count: ${data.generatedEmail.length}`;
    document.getElementById("output-container").style.display="block";
    document.getElementById("output-container").scrollIntoView({behavior:"smooth"});
    log("‚úÖ Email generated successfully.");
  }catch(e){ console.error(e); log("‚ùå Network/server error."); }
}

async function applyEnhancement(){
  let emailEl=document.getElementById("email"); let email=(emailEl?.value?.trim()||"");
  let tier=(window.userTier||"").toLowerCase(); if(tier!=="pro"&&tier!=="premium"){ alert("‚ùå Enhancement is only available for Pro and Premium users."); return; }
  if(!email){ email=localStorage.getItem("userEmail")?.trim()||""; if(email&&emailEl) emailEl.value=email; }
  const enhance_request=document.getElementById("enhance").value.trim(); const enhance_content=document.getElementById("result").textContent.trim();
  if(!enhance_request){ alert("Please enter an enhancement request."); return; }
  if(!enhance_content||!email){ alert("Missing original content or email address."); return; }
  log("üìù Applying enhancement: "+enhance_request);
  try{
    const res=await fetch("/enhance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,enhance_request,enhance_content})});
    const data=await res.json(); if(data.error){ alert("‚ùå "+data.error); log("‚ùå Enhance failed: "+data.error); return; }
    const updated=data.result||data.generatedEmail||enhance_content;
    document.getElementById("result").textContent=updated;
    document.getElementById("char-count").textContent=`Character count: ${updated.length}`;
    document.getElementById("enhance").value="";
    document.getElementById("output-container").scrollIntoView({behavior:"smooth"});
    log("‚úÖ Enhancement applied.");
  }catch(e){ alert("An error occurred during enhancement."); console.error(e); }
}
/* ================= EXPORTS / UTIL ================= */
function copyToClipboard(){ const t=document.getElementById("result").textContent; navigator.clipboard.writeText(t).then(()=>alert("‚úÖ Copied to clipboard!")); log("üìã Copied."); }
function exportToText(){ const t=document.getElementById("result").textContent; const cleaned=t.replace(/Logo:.*(\n)?/,''); const blob=new Blob([cleaned],{type:"application/octet-stream"}); triggerDownload(blob,getTimestampFilename("Smartlist_Listing","txt")); log("‚¨áÔ∏è TXT exported."); }
function exportToPDF_Instant(){
  const { jsPDF }=window.jspdf; const raw=document.getElementById("result").textContent;
  const stripped=raw.normalize("NFKD").replace(/[\u0300-\u036f]/g,'').replace(/[^\x00-\x7F]/g,''); const doc=new jsPDF();
  let y=20; if(window.logoImageBase64){ doc.addImage(window.logoImageBase64,'PNG',15,10,40,20); y=35; }
  const lines=doc.splitTextToSize(stripped,180); doc.text(lines,15,y); y+=lines.length*10;
  if(window.propertyImagesBase64&&window.propertyImagesBase64.length){ for(const img of window.propertyImagesBase64){ doc.addImage(img,'JPEG',15,y,60,45); y+=50; } }
  doc.save(getTimestampFilename("Smartlist_Listing","pdf")); log("‚¨áÔ∏è PDF exported (client).");
}
function exportToPDF(){
  if(window.userTier==="free"){ alert("‚ùå Export requires Pro or Premium tier."); return; }
  const content=document.getElementById("result").textContent; const logo=window.logoImageBase64||""; const images=window.propertyImagesBase64||[];
  fetch("/export-pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content,logo,images})})
    .then(r=>{ if(!r.ok) throw new Error("PDF export failed"); return r.blob(); })
    .then(b=>{ triggerDownload(b,getTimestampFilename("Smartlist_Listing","pdf")); log("‚¨áÔ∏è PDF exported (server)."); })
    .catch(e=>{ alert("‚ùå PDF export error: "+e.message); log("‚ùå PDF export error: "+e.message); });
}
function exportToWord(){
  if(window.userTier==="free"){ alert("‚ùå Export requires Pro or Premium tier."); return; }
  const content=document.getElementById("result").textContent; const logo=window.logoImageBase64||""; const images=window.propertyImagesBase64||[];
  fetch("/export-word",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content,logo,images})})
    .then(r=>{ if(!r.ok) throw new Error("DOCX export failed"); return r.blob(); })
    .then(b=>{ triggerDownload(b,getTimestampFilename("Smartlist_Listing","docx")); log("‚¨áÔ∏è DOCX exported."); })
    .catch(e=>{ alert("‚ùå DOCX export error: "+e.message); log("‚ùå DOCX export error: "+e.message); });
}
function triggerDownload(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.style.display='none'; a.rel="noopener"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
function clearAll(){ ["audience","purpose","tone","language","email","subject","email_content","sender_details","action","enhance"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  document.getElementById("result").textContent=""; document.getElementById("char-count").textContent=""; document.getElementById("output-container").style.display='none'; log("üßπ Form cleared."); }
document.getElementById("logoFile").addEventListener("change",function(){ const preview=document.getElementById("logo-preview"); preview.innerHTML=""; const file=this.files[0]; if(!file) return;
  if(file.size>2*1024*1024){ alert(`${file.name} exceeds 2MB limit.`); this.value=""; return; }
  const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.src=e.target.result; img.style.maxHeight="60px"; img.style.marginBottom="8px"; img.style.borderRadius="4px"; preview.appendChild(img);
    const del=document.createElement('button'); del.textContent='üóëÔ∏è Delete Logo'; del.onclick=function(){ document.getElementById('logoFile').value=""; document.getElementById('logo-preview').innerHTML=""; window.logoImageBase64=""; }; del.style.marginLeft='10px'; preview.appendChild(del);
    window.logoImageBase64=e.target.result; }; r.readAsDataURL(file); });
document.getElementById("images").addEventListener("change",function(){ const preview=document.getElementById("image-preview"); preview.innerHTML=""; window.propertyImagesBase64=[]; const files=Array.from(this.files);
  if(files.length>3){ alert("Maximum 3 images allowed."); this.value=""; return; }
  files.forEach(file=>{ if(file.size>2*1024*1024){ alert(`${file.name} exceeds 2MB limit.`); this.value=""; preview.innerHTML=""; return; }
    const r=new FileReader(); r.onload=e=>{ const base64=e.target.result; window.propertyImagesBase64.push(base64); const img=new Image(); img.src=e.target.result; img.style.maxHeight="100px"; img.style.marginRight="10px"; img.style.borderRadius="6px";
      const wrap=document.createElement('div'); wrap.style.display='inline-block'; wrap.style.position='relative'; const del=document.createElement('button'); del.textContent='üóëÔ∏è'; del.style.position='absolute'; del.style.top='0'; del.style.right='0';
      del.style.background='red'; del.style.color='white'; del.style.border='none'; del.style.borderRadius='50%'; del.style.cursor='pointer'; del.onclick=function(){ wrap.remove(); };
      wrap.appendChild(img); wrap.appendChild(del); preview.appendChild(wrap); }; r.readAsDataURL(file); }); });
function getTimestampFilename(base,ext){ const ts=new Date().toISOString().replace(/[:.]/g,'-'); return `${base}_${ts}.${ext}`; }
/* ================ END CORE JS ================ */

/* =========== Prefill from IMAP URL =========== */
(function universalPrefill(){
  try{
    const qs=new URLSearchParams(window.location.search); if(qs.toString()==='') return;
    const getAny=(keys,def='')=>{ for(const k of keys){ const v=qs.get(k); if(v) return v; } return def; };
    const fromName=getAny(['from','prefill_from_name','prefill_from','sender','sender_name']);
    const fromEmail=getAny(['prefill_from_email','sender_email','email_from']);
    const subject=getAny(['subject','prefill_subject','email_subject']);
    const body=getAny(['body','prefill_body','content','email_content']);
    const when=getAny(['prefill_date','date']);
    const importance=getAny(['prefill_importance','importance']);
    const $=id=>document.getElementById(id); const pick=(...ids)=>ids.map($).find(Boolean);

    const subjectEl=pick('subject','emailSubject','email_subject','email-subject');
    if(subjectEl&&subject){ subjectEl.value=subject; subjectEl.dispatchEvent(new Event('input',{bubbles:true})); subjectEl.dispatchEvent(new Event('change',{bubbles:true})); }

    const audienceEl=pick('target_audience','audience');
    if(audienceEl&&!audienceEl.value){ audienceEl.value=fromName||fromEmail||'Original sender'; audienceEl.dispatchEvent(new Event('change',{bubbles:true})); }

    const bodyEl=pick('email_content','emailContent','content','context','message','emailText','body');
    if(bodyEl){
      const header=[]; if(fromName||fromEmail) header.push(`> From: ${fromName||fromEmail}${fromEmail?` <${fromEmail}>`:''}`);
      if(when) header.push(`> Date: ${new Date(when).toLocaleString()}`); if(importance) header.push(`> Marked: ${importance}`);
      const prefix=(header.length?header.join('\n')+'\n\n':'')+(subject?`Subject: ${subject}\n\n`:'' );
      bodyEl.value=prefix+(body||''); bodyEl.dispatchEvent(new Event('input',{bubbles:true})); bodyEl.dispatchEvent(new Event('change',{bubbles:true}));
    }

    // NOTE: per your instruction, DO NOT auto-fill "sender_details" from incoming sender.
  }catch(e){ console.warn('Prefill skipped:',e); }
})();
<!-- ========= Reply Logic & SMTP Wiring (Corrected Patch C) ========= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const replyBtn = document.getElementById("replyGeneratedBtn");
  if (!replyBtn) return;

  replyBtn.addEventListener("click", async () => {
    // 1) Load SMTP settings (saved by the modal)
    const smtpHost        = localStorage.getItem("smtp_host");
    const smtpPort        = Number(localStorage.getItem("smtp_port") || 465);
    const smtpSecure      = (localStorage.getItem("smtp_secure") || "true") === "true";
    const smtpEmail       = localStorage.getItem("smtp_email");          // <-- use smtp_email (NOT smtp_user)
    const smtpPassword    = localStorage.getItem("smtp_password");
    const smtpAccessToken = localStorage.getItem("smtp_accessToken");
    const smtpAuthType    = (localStorage.getItem("smtp_authType") || "password");

    if (!smtpHost || !smtpEmail || (!smtpPassword && !smtpAccessToken)) {
      // Open modal to collect SMTP details
      const m = document.getElementById("smtpModal");
      if (m) m.style.display = "block";
      return;
    }

    // 2) Get the generated reply text
    const generated = (document.getElementById("result")?.textContent || "").trim();
    if (!generated) { alert("‚ùå No generated email to reply with."); return; }

    // 3) Read original IMAP context (if generator was opened from IMAP UI)
    let ctx = {};
    try { ctx = JSON.parse(sessionStorage.getItem("imap.generatorPayload") || "{}"); } catch {}
    const fromEmail   = (ctx.fromEmail || ctx.from || "").trim();
    const messageId   = ctx.messageId || null;
    const references  = Array.isArray(ctx.references) ? ctx.references : [];
    const origSubject = ctx.subject || "";

    // 4) Compute subject + recipient
    const uiSubject = (document.getElementById("subject")?.value || "").trim();
    const subjectBase = uiSubject || origSubject || "";
    const subject = /^re:\s/i.test(subjectBase) ? subjectBase : `Re: ${subjectBase}`.trim();
    const to = fromEmail || ""; // reply to original sender if available
    if (!to) { alert("‚ùå Missing original sender. Open the generator from the IMAP page so threading works."); return; }

    // 5) Build request for /api/imap/reply (threaded) OR fall back to /send
    const commonSmtp = {
      host: smtpHost,
      port: smtpPort,
      secure: smtpSecure,
      authType: smtpAuthType,
      email: smtpEmail,
      password: smtpPassword || "",
      accessToken: smtpAccessToken || ""
    };

    const endpoint = messageId ? "/api/imap/reply" : "/api/imap/send";
    const payload = messageId
      ? {
          ...commonSmtp,
          to,
          subject,
          text: generated,
          html: "",
          orig: { messageId, references }
        }
      : {
          ...commonSmtp,
          from: smtpEmail,
          to,
          subject,
          text: generated,
          html: "",
          attachments: []
        };

    // 6) Send
    try {
      const r = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok || j.ok === false) throw new Error(j.error || "Send failed");
      alert(messageId ? "‚úÖ Reply sent in thread." : "‚úÖ Email sent.");
      console.log("Send result:", j);
    } catch (e) {
      alert("‚ùå Send failed: " + (e?.message || e));
      console.error(e);
    }
  });

  // 7) Wire modal save (IDs must match your modal)
  const saveBtn = document.getElementById("smtpSaveBtn");
  if (saveBtn && !saveBtn.__wired) {
    saveBtn.__wired = true;
    saveBtn.addEventListener("click", () => {
      localStorage.setItem("smtp_host",        document.getElementById("smtp_host").value.trim());
      localStorage.setItem("smtp_port",        document.getElementById("smtp_port").value.trim());
      localStorage.setItem("smtp_secure",      document.getElementById("smtp_secure").value);
      localStorage.setItem("smtp_authType",    document.getElementById("smtp_authType").value);
      localStorage.setItem("smtp_email",       document.getElementById("smtp_email").value.trim());      // <-- save smtp_email
      localStorage.setItem("smtp_password",    document.getElementById("smtp_password").value);
      localStorage.setItem("smtp_accessToken", document.getElementById("smtp_accessToken").value);
      const m = document.getElementById("smtpModal"); if (m) m.style.display = "none";
      alert("‚úÖ SMTP settings saved. Click Reply again to send.");
    });
  }

  const cancelBtn = document.getElementById("smtpCancelBtn");
  if (cancelBtn && !cancelBtn.__wired) {
    cancelBtn.__wired = true;
    cancelBtn.addEventListener("click", () => {
      const m = document.getElementById("smtpModal"); if (m) m.style.display = "none";
    });
  }
});
  </script>
<!-- ========= End Patch C ========= -->

<script>
/* =========== Attach listeners once =========== */
document.addEventListener("DOMContentLoaded", () => {
  const generateBtn = document.getElementById("generateBtn");
  const enhanceBtn  = document.getElementById("enhanceBtn");
  if (generateBtn) generateBtn.addEventListener("click", generate, { once:false });
  if (enhanceBtn)  enhanceBtn.addEventListener("click", applyEnhancement, { once:false });

  // üîß NEW: pull any saved tier before first paint
  const stored =
    (localStorage.getItem("smartemail_tier") ||
     localStorage.getItem("smartemail.tier")  ||
     localStorage.getItem("license_tier")     ||
     window.userTier || "free");

  setTier(stored);          // normalize + paint badge
  updateFeatureAccess();    // enable/disable buttons accordingly
});
</script>

<!-- ========= LEGAL FOOTER & MODALS ========= -->
<footer id="legalFooter" style="margin-top:40px;padding:18px 0 6px 0; text-align:center; background:transparent; color:#888; font-size:13px;">
  <span style="margin:0 12px; cursor:pointer; text-decoration:underline;" onclick="showLegal('privacy')">Privacy Policy</span>
  <span style="margin:0 12px; cursor:pointer; text-decoration:underline;" onclick="showLegal('terms')">Terms of Use</span>
  <span style="margin:0 12px; cursor:pointer; text-decoration:underline;" onclick="showLegal('compliance')">Compliance</span>
  <span style="margin:0 12px; font-style:italic;">Patent Pending</span>
</footer>

<div id="legalModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(25,25,25,0.28); backdrop-filter: blur(1px);">
  <div id="legalBox" style="background:#fff; max-width:580px; margin:6vh auto 0; border-radius:12px; box-shadow:0 8px 42px rgba(0,0,0,0.17); padding:32px 24px 26px; position:relative; color:#263238; font-size:15px; line-height:1.68;">
    <button onclick="hideLegal()" style="position:absolute;top:14px;right:18px;background:#f5f5f5;color:#444;border:none;font-size:15px;padding:5px 14px;border-radius:8px;cursor:pointer;">Close</button>
    <div id="legalContent"></div>
  </div>
</div>
<!-- SMTP Settings Modal -->
<div id="smtpModal" class="modal-bg" style="display:none;">
  <div class="modal-card" style="max-width:420px;">
    <h3 style="margin-top:0;">SMTP Settings</h3>
    <p style="color:#666;margin-top:6px;">Use an app password if your provider requires one.</p>
    <div class="form-row"><label>Host</label><input id="smtp_host" type="text" placeholder="smtp.gmail.com"/></div>
    <div class="form-row"><label>Port</label><input id="smtp_port" type="number" value="465"/></div>
    <div class="form-row"><label>Secure (TLS)</label><select id="smtp_secure"><option value="true" selected>Yes (465)</option><option value="false">No (587)</option></select></div>
    <div class="form-row"><label>Auth Type</label><select id="smtp_authType"><option value="password" selected>Password</option><option value="xoauth2">OAuth2 (Token)</option></select></div>
    <div class="form-row"><label>Email (From)</label><input id="smtp_email" type="email" placeholder="you@example.com"/></div>
    <div class="form-row"><label>Password / App Password</label><input id="smtp_password" type="password"/></div>
    <div class="form-row"><label>Access Token (OAuth2)</label><input id="smtp_accessToken" type="text" placeholder="Optional for OAuth2"/></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button id="smtpSaveBtn" style="background:#1976d2;color:#fff;">Save</button>
      <button id="smtpCancelBtn" style="background:#aaa;">Cancel</button>
    </div>
  </div>
</div>

<script>
  const legalTexts={
    privacy:`<h3 style="margin-top:0">Privacy Policy</h3>
      <p>Your privacy is important. We comply with POPIA, GDPR, CCPA and all global data laws. Only essential info (email, license key) is stored to deliver features and is never sold or used for marketing.</p>
      <ul><li>All data is encrypted in transit and at rest.</li><li>No personal data is shared with third parties except for payment/license verification (e.g., Stripe, Supabase).</li><li>You may request deletion of your account or data any time by emailing <a href="mailto:support@smartmail.store">support@smartmail.store</a>.</li><li>AI outputs are not permanently stored or used to train external models.</li></ul>
      <p>For full details, <a href="mailto:support@smartmail.store">contact us</a>.</p>`,
    terms:`<h3 style="margin-top:0">Terms of Use</h3>
      <ul><li>This service is provided "as is" and may be withdrawn at any time.</li><li>You must not misuse the service, attempt to reverse engineer it, or use it for unlawful activity.</li><li>Paid tiers are delivered on a best effort; refunds for non-delivery will be processed if confirmed.</li><li>AI outputs are for informational use only; we make no guarantee as to accuracy or fitness for any purpose.</li><li>By using this app, you consent to basic data collection (see Privacy Policy).</li><li>All IP, code, and content remain the property of Smartlist. System and Method for Real-Time Multimodal AI Content Generation and Iterative Enhancement ‚Äì Patent Pending (2025/05246).</li></ul>
      <p>If you disagree with these terms, do not use the app. For queries, email <a href="mailto:support@promptagenthq.com">support@promptagenthq.com</a>.</p>`,
    compliance:`<h3 style="margin-top:0">Compliance & Global Notices</h3>
      <ul><li><b>POPIA/POPI (South Africa):</b> We respect your right to privacy and process all personal info lawfully and minimally.</li><li><b>GDPR (EU/UK):</b> Data subjects may request access, correction, or deletion of their data. No profiling or automated decisions.</li><li><b>CCPA (California):</b> California residents have the right to opt out of data sharing and request deletion.</li><li><b>AI Output Notice:</b> Listings are AI-generated and may contain errors or bias. Use at your own discretion.</li><li>For any privacy or compliance request, contact: <a href="mailto:support@promptagenthq.com">support@promptagenthq.com</a></li></ul>`
  };
  function showLegal(which){ document.getElementById('legalContent').innerHTML=legalTexts[which]||''; document.getElementById('legalModal').style.display='block'; document.body.style.overflow='hidden'; }
  function hideLegal(){ document.getElementById('legalModal').style.display='none'; document.body.style.overflow=''; }
</script>




  
<script>
// === Runtime Advanced wrapper (dedupe-safe) ===
(function(){
  try{
    // Remove any stray duplicate Advanced blocks that might exist
    document.querySelectorAll('details#advancedRefinements').forEach(el => el.remove());

    // Find existing refinement fields (by IDs already in the page)
    const f = document.getElementById('formality');
    const l = document.getElementById('length');
    const a = document.getElementById('audience_role');
    if(!f && !l && !a) return; // nothing to wrap

    // Build the <details> container
    const details = document.createElement('details');
    details.id = 'advancedRefinements';
    details.style.margin = '12px 0';
    const summary = document.createElement('summary');
    summary.textContent = 'Advanced (optional)';
    summary.style.cursor = 'pointer';
    summary.style.fontWeight = '600';
    details.appendChild(summary);

    const inner = document.createElement('div');
    inner.style.display = 'flex';
    inner.style.gap = '12px';
    inner.style.flexWrap = 'wrap';
    inner.style.marginTop = '8px';
    details.appendChild(inner);

    // Helper to move a label+field pair into the details in the RIGHT order they appear on page
    function moveFieldById(id, labelText){
      const el = document.getElementById(id);
      if(!el) return;
      // Try to capture a surrounding label or form-group container to keep styling
      let container = el.closest('label, .form-group, .row, .col, div') || el;
      // If the label is separate, create a new wrapper label for clarity
      if(container === el && !el.closest('label')){
        const wrap = document.createElement('label');
        wrap.style.flex = '1 1 220px';
        wrap.style.minWidth = '220px';
        wrap.textContent = labelText + ' ';
        el.parentNode.insertBefore(wrap, el);
        wrap.appendChild(el);
        container = wrap;
      } else {
        // Ensure min sizing for grid feel
        container.style.flex = '1 1 220px';
        container.style.minWidth = '220px';
      }
      inner.appendChild(container);
    }

    // Maintain visual order: Formality, Length, Audience Role
    moveFieldById('formality','Formality');
    moveFieldById('length','Preferred Length');
    moveFieldById('audience_role','Audience Role');

    // Insert the Advanced details just before the primary generate button (or at end of main)
    const insertBeforeBtn = Array.from(document.querySelectorAll('button'))
      .find(b => /generate/i.test(b.textContent||''));
    if(insertBeforeBtn && insertBeforeBtn.parentNode){
      insertBeforeBtn.parentNode.parentNode.insertBefore(details, insertBeforeBtn.parentNode);
    } else {
      const main = document.querySelector('main') || document.body;
      main.appendChild(details);
    }
  }catch(e){ console.warn('Advanced wrapper init failed:', e); }
})();
// === End runtime Advanced wrapper ===
</script>

<script>
// === Prefill from IMAP sessionStorage (full body support) ===
(function(){
  let payload = null;
  try {
    payload = JSON.parse(sessionStorage.getItem("imap.generatorPayload") || "null");
  } catch {}
  if (!payload) return;

  // Map values to your existing fields
  if (payload.subject) document.getElementById("subject").value = payload.subject;
  if (payload.body && payload.body.trim()) document.getElementById("email_content").value = payload.body; else if (payload.snippet && payload.snippet.trim()) document.getElementById("email_content").value = payload.snippet;
  if (payload.from) document.getElementById("email").value = payload.from;

  // optional: mark loaded
  const log = document.getElementById("debugLog");
  if (log) log.value += `${new Date().toISOString()} ‚Äî üì• Loaded email from IMAP selection\n`;

  // clear after use
  try { sessionStorage.removeItem("imap.generatorPayload"); } catch {}
})();
</script>
  
</body>
</html>
